(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[586,470],{4746:(e,t,s)=>{"use strict";s.r(t),s.d(t,{P2pMediaLoaderPlugin:()=>p});var i,r=s(4538),a=s.n(r),n=s(3654),o=s.n(n),l=s(7350),h=s(569),d=s(5723);class u{constructor(e,t,s){this.errorCounts={},this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null,playing:null,textTracksChange:null,audioTracksChange:null},this.uiTextTrackHandled=!1,this.vjs=e,this.source=t,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=e(s.options_.playerId),this.videoElement.addEventListener("error",(e=>{let t;const s=(e.currentTarget||e.target).error;if(s){switch(console.log(s),s.code){case s.MEDIA_ERR_ABORTED:t="You aborted the video playback";break;case s.MEDIA_ERR_DECODE:t="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(s);break;case s.MEDIA_ERR_NETWORK:t="A network error caused the video download to fail part-way";break;case s.MEDIA_ERR_SRC_NOT_SUPPORTED:t="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:t=s.message}console.error("MEDIA_ERROR: ",t)}})),this.initialize()}duration(){return this._duration||this.videoElement.duration||0}seekable(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);const e=Math.round(this.hls.media.duration-this.dvrDuration),t=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(e,t)}return this.vjs.createTimeRanges()}dispose(){this.videoElement.removeEventListener("play",this.handlers.play),this.videoElement.removeEventListener("playing",this.handlers.playing),this.player.textTracks().removeEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!1,this.hls.destroy()}static addHook(e,t){u.hooks[e]=this.hooks[e]||[],u.hooks[e].push(t)}static removeHook(e,t){if(void 0===u.hooks[e])return!1;const s=u.hooks[e].indexOf(t);return-1!==s&&(u.hooks[e].splice(s,1),!0)}_executeHooksFor(e){if(void 0!==u.hooks[e])for(let t=0;t<u.hooks[e].length;t++)u.hooks[e][t](this.player,this.hls)}_handleMediaError(e){return 1===this.errorCounts[a().ErrorTypes.MEDIA_ERROR]?(console.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[a().ErrorTypes.MEDIA_ERROR]?(console.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):void(this.errorCounts[a().ErrorTypes.MEDIA_ERROR]>2&&(console.info("bubbling media error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>e,this.tech.trigger("error")))}_handleNetworkError(e){if(this.errorCounts[a().ErrorTypes.NETWORK_ERROR]<=5)return console.info("trying to recover network error"),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(a().Events.FRAG_LOADED,(()=>{this.errorCounts[a().ErrorTypes.NETWORK_ERROR]=0}));console.info("bubbling network error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>e,this.tech.trigger("error")}_onError(e,t){const s={message:`HLS.js error: ${t.type} - fatal: ${t.fatal} - ${t.details}`};this.errorCounts[t.type]?this.errorCounts[t.type]+=1:this.errorCounts[t.type]=1,t.fatal?console.warn(s.message):console.error(s.message,t),t.type===a().ErrorTypes.NETWORK_ERROR?(s.code=2,this._handleNetworkError(s)):t.fatal&&t.type===a().ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==t.details?(s.code=3,this._handleMediaError(s)):t.fatal&&(this.hls.destroy(),console.info("bubbling error up to VIDEOJS"),this.tech.error=()=>s,this.tech.trigger("error"))}switchQuality(e){this.hls.currentLevel=e}_levelLabel(e){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(e):e.height?e.height+"p":e.width?Math.round(9*e.width/16)+"p":e.bitrate?e.bitrate/1e3+"kbps":0}_relayQualityChange(e){let t,s=!0;for(let t=0;t<e.length;t++)if(!e[t]._enabled){s=!1;break}if(s)this.hls.currentLevel=-1;else{for(t=e.length-1;t>=0&&!e[t]._enabled;t--);this.hls.currentLevel=t}}_handleQualityLevels(){var e,t;if(!this.metadata)return;const s=null===(t=(e=this.player).qualityLevels)||void 0===t?void 0:t.call(e);if(s)for(let e=0;e<this.metadata.levels.length;e++){const t=this.metadata.levels[e],i={id:e,width:t.width,height:t.height,bandwidth:t.bitrate,bitrate:t.bitrate,_enabled:!0},r=this;i.enabled=function(e,t){return"boolean"==typeof t&&(this[e]._enabled=t,r._relayQualityChange(this)),this[e]._enabled},s.addQualityLevel(i)}}_notifyVideoQualities(){if(!this.metadata)return;const e=[];this.metadata.levels.length>1&&e.push({id:-1,label:"auto",selected:-1===this.hls.manualLevel}),this.metadata.levels.forEach(((t,s)=>{const i={id:s,selected:s===this.hls.manualLevel,label:this._levelLabel(t)};e.push(i)}));const t={qualityData:{video:e},qualitySwitchCallback:this.switchQuality.bind(this)};this.tech.trigger("loadedqualitydata",t),this.videoElement.removeEventListener("playing",this.handlers.playing)}_updateSelectedAudioTrack(){const e=this.tech.audioTracks();for(let t=0;t<e.length;t++)if(e[t].enabled){this.hls.audioTrack=t;break}}_onAudioTracks(){const e=this.hls.audioTracks,t=this.tech.audioTracks();if(e.length>1&&0===t.length){for(let s=0;s<e.length;s++)t.addTrack(new this.vjs.AudioTrack({id:s.toString(),kind:"alternative",label:e[s].name||e[s].lang,language:e[s].lang,enabled:s===this.hls.audioTrack}));this.handlers.audioTracksChange=this._updateSelectedAudioTrack.bind(this),t.addEventListener("change",this.handlers.audioTracksChange)}}_getTextTrackLabel(e){return e.label?e.label:e.language}_isSameTextTrack(e,t){return this._getTextTrackLabel(e)===this._getTextTrackLabel(t)&&e.kind===t.kind}_updateSelectedTextTrack(){const e=this.player.textTracks();let t=null;for(let s=0;s<e.length;s++)if("showing"===e[s].mode){t=e[s];break}const s=this.videoElement.textTracks;for(let e=0;e<s.length;e++)"subtitles"!==s[e].kind&&"captions"!==s[e].kind||(s[e].mode=t&&this._isSameTextTrack(s[e],t)?"showing":"disabled")}_startLoad(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}_oneLevelObjClone(e){const t={},s=Object.keys(e);for(let i=0;i<s.length;i++)t[s[i]]=e[s[i]];return t}_filterDisplayableTextTracks(e){const t=[];for(let s=0;s<e.length;s++)"subtitles"!==e[s].kind&&"captions"!==e[s].kind||t.push(e[s]);return t}_updateTextTrackList(){const e=this._filterDisplayableTextTracks(this.videoElement.textTracks),t=this.player.textTracks();for(let s=0;s<e.length;s++){let i=!1;for(let r=0;r<t.length;r++)if(this._isSameTextTrack(e[s],t[r])){i=!0;break}if(!i){const t=e[s];this.player.addRemoteTextTrack({kind:t.kind,label:this._getTextTrackLabel(t),language:t.language,srclang:t.language},!1)}}this._updateSelectedTextTrack(),this.uiTextTrackHandled||(this.handlers.textTracksChange=this._updateSelectedTextTrack.bind(this),t.addEventListener("change",this.handlers.textTracksChange),this.uiTextTrackHandled=!0)}_onMetaData(e,t){this.metadata=t,this._handleQualityLevels()}_createCueHandler(e){return{newCue:(t,s,i,r)=>{let a,n,o;const l=window.VTTCue||window.TextTrackCue;for(let h=0;h<r.rows.length;h++)if(a=r.rows[h],o="",!a.isEmpty()){for(let e=0;e<a.chars.length;e++)o+=a.chars[e].ucharj;if(n=new l(s,i,o.trim()),null!=e&&"object"==typeof e){const t=Object.keys(e);for(let s=0;s<t.length;s++)n[t[s]]=e[t[s]]}t.addCue(n),i===s&&t.addCue(new l(i+5,""))}}}}_initHlsjs(){const e=this.tech.options_,t=this.player.srOptions_,s=(null==t?void 0:t.hlsjsConfig)||e.hlsjsConfig;this.hlsjsConfig=s?this._oneLevelObjClone(s):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1);const i=(null==t?void 0:t.captionConfig)||e.captionConfig;i&&(this.hlsjsConfig.cueHandler=this._createCueHandler(i)),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.handlers.playing=this._notifyVideoQualities.bind(this),this.videoElement.addEventListener("playing",this.handlers.playing),this.hls=new(a())(this.hlsjsConfig),this._executeHooksFor("beforeinitialize"),this.hls.on(a().Events.ERROR,((e,t)=>this._onError(e,t))),this.hls.on(a().Events.AUDIO_TRACKS_UPDATED,(()=>this._onAudioTracks())),this.hls.on(a().Events.MANIFEST_PARSED,((e,t)=>this._onMetaData(e,t))),this.hls.on(a().Events.LEVEL_LOADED,((e,t)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*t.details.targetduration),this.isLive=t.details.live,this.dvrDuration=t.details.totalduration,this._duration=this.isLive?1/0:t.details.totalduration})),this.hls.once(a().Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}initialize(){this._initHlsjs()}}u.hooks={},((i=o()).registerPlugin||i.plugin)("hlsjs",(function(e){const t=this;e&&(t.srOptions_||(t.srOptions_={}),t.srOptions_.hlsjsConfig||(t.srOptions_.hlsjsConfig=e.hlsjsConfig),t.srOptions_.captionConfig||(t.srOptions_.captionConfig=e.captionConfig),e.levelLabelHandler&&!t.srOptions_.levelLabelHandler&&(t.srOptions_.levelLabelHandler=e.levelLabelHandler))})),function(e){if(!a().isSupported())return void console.warn("Hls.js is not supported in this browser!");const t=e.getTech("Html5");t?(t.registerSourceHandler({canHandleSource:function(e){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(e.type)?"probably":/\.m3u8/i.test(e.src)?"maybe":""},handleSource:function(t,s){return s.hlsProvider&&s.hlsProvider.dispose(),s.hlsProvider=new u(e,t,s),s.hlsProvider}},0),e.Html5Hlsjs=u):console.error("Not supported version if video.js")}(o());const c=o().getPlugin("plugin");class p extends c{constructor(e,t){if(super(e),this.CONSTANTS={INFO_SCHEDULER:1e3},this.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},this.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},this.options=t,o().Html5Hlsjs)o().Html5Hlsjs.addHook("beforeinitialize",((e,t)=>{this.hlsjs=t})),(0,h.initVideoJsContribHlsJsPlayer)(e);else if(console.warn("HLS.js does not seem to be supported. Try to fallback to built in HLS."),!e.canPlayType("application/vnd.apple.mpegurl")){const t="Cannot fallback to built-in HLS";return console.warn(t),void e.ready((()=>e.trigger("error",new Error(t))))}this.startTime=(0,d.h8)(t.startTime),e.src({type:t.type,src:t.src}),e.ready((()=>{this.initializeCore(),o().Html5Hlsjs&&this.initializePlugin()}))}dispose(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}getCurrentLevel(){return this.hlsjs.levels[this.hlsjs.currentLevel]}getLiveLatency(){return Math.round(this.hlsjs.latency)}getHLSJS(){return this.hlsjs}initializeCore(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}initializePlugin(){(0,h.initHlsJsPlayer)(this.hlsjs);const e=this.player.tech(!0).options_;this.p2pEngine=e.hlsjsConfig.loader.getEngine(),this.hlsjs.on(a().Events.LEVEL_SWITCHING,((e,t)=>{this.trigger("resolutionChange",{auto:this.hlsjs.autoLevelEnabled,resolutionId:t.height})})),this.hlsjs.on(a().Events.MANIFEST_LOADED,((e,t)=>{this.trigger("resolutionsLoaded")})),this.p2pEngine.on(l.Events.SegmentError,((e,t)=>{console.error("Segment error.",e,t),this.options.redundancyUrlManager.removeBySegmentUrl(e.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}runStats(){this.p2pEngine.on(l.Events.PieceBytesDownloaded,((e,t,s)=>{const i="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;i.pendingDownload.push(s),i.totalDownload+=s})),this.p2pEngine.on(l.Events.PieceBytesUploaded,((e,t,s)=>{const i="p2p"===e?this.statsP2PBytes:this.statsHTTPBytes;i.pendingUpload.push(s),i.totalUpload+=s})),this.p2pEngine.on(l.Events.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(l.Events.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{const e=this.arraySum(this.statsP2PBytes.pendingDownload),t=this.arraySum(this.statsP2PBytes.pendingUpload),s=this.arraySum(this.statsHTTPBytes.pendingDownload),i=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:s,uploadSpeed:i,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:e,uploadSpeed:t,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload},bandwidthEstimate:this.hlsjs.bandwidthEstimate/8})}),this.CONSTANTS.INFO_SCHEDULER)}arraySum(e){return e.reduce(((e,t)=>e+t),0)}}o().registerPlugin("p2pMediaLoader",p)},9354:()=>{},3762:()=>{},8333:()=>{},59:()=>{},2361:()=>{},4616:()=>{},3719:()=>{}}]);