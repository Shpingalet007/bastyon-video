/*! For license information please see 569.c507837d624bec4d6ab0.chunk.js.LICENSE.txt */
(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[569],{6456:function(t,e,s){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.BandwidthApproximator=void 0;const n=i(s(7642)).default("p2pml:bandwidth-approximator"),a=2e3;class r{constructor(t,e){this.value=t,this.timeStamp=e}}e.BandwidthApproximator=class{constructor(){this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(t,e)=>{for(n("Add %d bytes.",t),this.lastBytes.push(new r(t,e)),this.currentBytesSum+=t;e-this.lastBytes[0].timeStamp>a;)this.currentBytesSum-=this.lastBytes.shift().value;const s=Math.min(a,e);this.lastBandwidth.push(new r(this.currentBytesSum/s,e))},this.getBandwidth=t=>{for(;0!==this.lastBandwidth.length&&t-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let e=0;for(const t of this.lastBandwidth)t.value>e&&(e=t.value);return n("Max bandwidth: %d.",e),e},this.getSmoothInterval=()=>a,this.getMeasureInterval=()=>4e4}}},2695:function(t,e,s){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.HttpMediaManager=void 0;const n=i(s(7642)),a=s(9731);class r extends a.STEEmitter{}e.HttpMediaManager=class extends r{constructor(t){super(),this.settings=t,this.xhrRequests=new Map,this.failedSegments=new Map,this.debug=n.default("p2pml:http-media-manager"),this.download=(t,e)=>{if(this.isDownloading(t))return;this.cleanTimedOutFailedSegments(),this.emit("segment-start-load",t);const s=this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(t):t.url;this.debug("http segment download",s),t.requestUrl=s;const i=new XMLHttpRequest;if(i.open("GET",s,!0),i.responseType="arraybuffer",t.range)i.setRequestHeader("Range",t.range),e=void 0;else if(void 0!==e&&this.settings.httpUseRanges){let t=0;for(const s of e)t+=s.byteLength;i.setRequestHeader("Range","bytes=".concat(t,"-")),this.debug("continue download from",t)}else e=void 0;this.setupXhrEvents(i,t,e),this.settings.xhrSetup&&this.settings.xhrSetup(i,s),this.xhrRequests.set(t.id,{xhr:i,segment:t}),i.send()},this.abort=t=>{const e=this.xhrRequests.get(t.id);e&&(e.xhr.abort(),this.xhrRequests.delete(t.id),this.debug("http segment abort",t.id))},this.isDownloading=t=>this.xhrRequests.has(t.id),this.isFailed=t=>{const e=this.failedSegments.get(t.id);return void 0!==e&&e>this.now()},this.getActiveDownloads=()=>this.xhrRequests,this.getActiveDownloadsCount=()=>this.xhrRequests.size,this.destroy=()=>{this.xhrRequests.forEach((t=>t.xhr.abort())),this.xhrRequests.clear()},this.setupXhrEvents=(t,e,s)=>{let i=0;t.addEventListener("progress",(t=>{this.emit("bytes-downloaded",e,t.loaded-i),i=t.loaded,t.lengthComputable&&this.emit("segment-size",e,t.total)})),t.addEventListener("load",(async i=>{if(t.status<200||t.status>=300)return void this.segmentFailure(e,i,t);let n=t.response;if(void 0!==s&&206===t.status){let t=0;for(const e of s)t+=e.byteLength;const e=new Uint8Array(t+n.byteLength);let i=0;for(const t of s)e.set(new Uint8Array(t),i),i+=t.byteLength;e.set(new Uint8Array(n),i),n=e.buffer}await this.segmentDownloadFinished(e,n,t)})),t.addEventListener("error",(s=>{this.segmentFailure(e,s,t)})),t.addEventListener("timeout",(s=>{this.segmentFailure(e,s,t)}))},this.segmentDownloadFinished=async(t,e,s)=>{if(t.responseUrl=null===s.responseURL?void 0:s.responseURL,this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},t),{data:e}),"http")}catch(e){return this.debug("segment validator failed",e),void this.segmentFailure(t,e,s)}this.xhrRequests.delete(t.id),this.emit("segment-loaded",t,e)},this.segmentFailure=(t,e,s)=>{t.responseUrl=null===s.responseURL?void 0:s.responseURL,this.xhrRequests.delete(t.id),this.failedSegments.set(t.id,this.now()+this.settings.httpFailedSegmentTimeout),this.emit("segment-error",t,e)},this.cleanTimedOutFailedSegments=()=>{const t=this.now(),e=[];this.failedSegments.forEach(((s,i)=>{s<t&&e.push(i)})),e.forEach((t=>this.failedSegments.delete(t)))},this.now=()=>performance.now()}}},223:function(t,e,s){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.HybridLoader=void 0;const n=i(s(7642)),a=s(4575),r=i(s(5151)),o=s(9979),d=s(2695),g=s(9045),h=s(4136),l=s(6456),u=s(9622),m={cachedSegmentExpiration:3e5,cachedSegmentsCount:30,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:1,simultaneousHttpDownloads:2,httpDownloadProbability:.1,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1e4,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:4e3,httpUseRanges:!1,simultaneousP2PDownloads:3,p2pDownloadMaxPriority:20,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:r.default.config};class c extends a.EventEmitter{constructor(t={}){super(),this.debug=n.default("p2pml:hybrid-loader"),this.debugSegments=n.default("p2pml:hybrid-loader-segments"),this.segmentsQueue=[],this.bandwidthApproximator=new l.BandwidthApproximator,this.httpDownloadInitialTimeoutTimestamp=-1/0,this.createHttpManager=()=>new d.HttpMediaManager(this.settings),this.createP2PManager=()=>new g.P2PMediaManager(this.segmentsStorage,this.settings),this.load=async(t,e)=>{void 0===this.httpRandomDownloadInterval&&(this.httpRandomDownloadInterval=setInterval(this.downloadRandomSegmentOverHttp,this.settings.httpDownloadProbabilityInterval),this.settings.httpDownloadInitialTimeout>0&&this.settings.httpDownloadInitialTimeoutPerSegment>0&&(this.debugSegments("enable initial HTTP download timeout",this.settings.httpDownloadInitialTimeout,"per segment",this.settings.httpDownloadInitialTimeoutPerSegment),this.httpDownloadInitialTimeoutTimestamp=this.now(),setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment+100))),t.length>0&&(this.masterSwarmId=t[0].masterSwarmId),void 0!==this.masterSwarmId&&this.p2pManager.setStreamSwarmId(e,this.masterSwarmId),this.debug("load segments");let s=!1;for(const e of this.segmentsQueue)t.find((t=>t.url===e.url))||(this.debug("remove segment",e.url),this.httpManager.isDownloading(e)?(s=!0,this.httpManager.abort(e)):this.p2pManager.abort(e),this.emit(o.Events.SegmentAbort,e));if(this.debug.enabled)for(const e of t)this.segmentsQueue.find((t=>t.url===e.url))||this.debug("add segment",e.url);if(this.segmentsQueue=t,void 0===this.masterSwarmId)return;let i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);s=this.processSegmentsQueue(i)||s,await this.cleanSegmentsStorage()&&(i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),s=!0),s&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))},this.getSegment=async t=>void 0===this.masterSwarmId?void 0:this.segmentsStorage.getSegment(t,this.masterSwarmId),this.getSettings=()=>this.settings,this.getDetails=()=>({peerId:this.p2pManager.getPeerId()}),this.getBandwidthEstimate=()=>this.bandwidthApproximator.getBandwidth(this.now()),this.destroy=async()=>{void 0!==this.httpRandomDownloadInterval&&(clearInterval(this.httpRandomDownloadInterval),this.httpRandomDownloadInterval=void 0),this.httpDownloadInitialTimeoutTimestamp=-1/0,this.segmentsQueue=[],this.httpManager.destroy(),this.p2pManager.destroy(),this.masterSwarmId=void 0,await this.segmentsStorage.destroy()},this.processInitialSegmentTimeout=async()=>{if(void 0!==this.httpRandomDownloadInterval){if(void 0!==this.masterSwarmId){const t=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(t)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(t))}this.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(this.processInitialSegmentTimeout,this.settings.httpDownloadInitialTimeoutPerSegment)}},this.processSegmentsQueue=t=>{if(this.debugSegments("process segments queue. priority",this.segmentsQueue.length>0?this.segmentsQueue[0].priority:0),void 0===this.masterSwarmId||0===this.segmentsQueue.length)return!1;let e,s=!1,i=!0;if(this.httpDownloadInitialTimeoutTimestamp!==-1/0){let e;for(const s of this.segmentsQueue)if(!t.has(s.id)){e=s.priority;break}const s=this.now()-this.httpDownloadInitialTimeoutTimestamp;i=s>=this.settings.httpDownloadInitialTimeout||void 0!==e&&s>this.settings.httpDownloadInitialTimeoutPerSegment&&e<=0,i&&(this.debugSegments("cancel initial HTTP download timeout - timed out"),this.httpDownloadInitialTimeoutTimestamp=-1/0)}for(let n=0;n<this.segmentsQueue.length;n++){const a=this.segmentsQueue[n];if(!t.has(a.id)&&!this.httpManager.isDownloading(a)){if(a.priority<=this.settings.requiredSegmentsPriority&&i&&!this.httpManager.isFailed(a)){if(this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads)for(let t=this.segmentsQueue.length-1;t>n;t--){const e=this.segmentsQueue[t];if(this.httpManager.isDownloading(e)){this.debugSegments("cancel HTTP download",e.priority,e.url),this.httpManager.abort(e);break}}if(this.httpManager.getActiveDownloadsCount()<this.settings.simultaneousHttpDownloads){const t=this.p2pManager.abort(a);this.httpManager.download(a,t),this.debugSegments("HTTP download (priority)",a.priority,a.url),s=!0;continue}}if(!this.p2pManager.isDownloading(a))if(a.priority<=this.settings.requiredSegmentsPriority){if(e=e||this.p2pManager.getOverallSegmentsMap(),e.get(a.id)!==h.MediaPeerSegmentStatus.Loaded)continue;if(this.p2pManager.getActiveDownloadsCount()>=this.settings.simultaneousP2PDownloads)for(let t=this.segmentsQueue.length-1;t>n;t--){const e=this.segmentsQueue[t];if(this.p2pManager.isDownloading(e)){this.debugSegments("cancel P2P download",e.priority,e.url),this.p2pManager.abort(e);break}}if(this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&this.p2pManager.download(a)){this.debugSegments("P2P download (priority)",a.priority,a.url);continue}}else this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&a.priority<=this.settings.p2pDownloadMaxPriority&&this.p2pManager.download(a)&&this.debugSegments("P2P download",a.priority,a.url)}}return s},this.downloadRandomSegmentOverHttp=async()=>{if(void 0===this.masterSwarmId||void 0===this.httpRandomDownloadInterval||this.httpDownloadInitialTimeoutTimestamp!==-1/0||this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads||this.settings.httpDownloadProbabilitySkipIfNoPeers&&0===this.p2pManager.getPeers().size||this.settings.consumeOnly)return;const t=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId),e=this.p2pManager.getOverallSegmentsMap(),s=this.segmentsQueue.filter((s=>!this.p2pManager.isDownloading(s)&&!this.httpManager.isDownloading(s)&&!e.has(s.id)&&!this.httpManager.isFailed(s)&&s.priority<=this.settings.httpDownloadMaxPriority&&!t.has(s.id)));if(0===s.length)return;if(Math.random()>this.settings.httpDownloadProbability*s.length)return;const i=s[Math.floor(Math.random()*s.length)];this.debugSegments("HTTP download (random)",i.priority,i.url),this.httpManager.download(i),this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(t))},this.onSegmentStartLoad=(t,e)=>{this.emit(o.Events.SegmentStartLoad,t,e)},this.onPieceBytesDownloaded=(t,e,s,i)=>{this.bandwidthApproximator.addBytes(s,this.now()),this.emit(o.Events.PieceBytesDownloaded,t,e,s,i)},this.onPieceBytesUploaded=(t,e,s,i)=>{this.emit(o.Events.PieceBytesUploaded,t,e,s,i)},this.onSegmentLoaded=async(t,e,s)=>{if(this.debugSegments("segment loaded",t.id,t.url),void 0===this.masterSwarmId)return;t.data=e,t.downloadBandwidth=this.bandwidthApproximator.getBandwidth(this.now()),await this.segmentsStorage.storeSegment(t),this.emit(o.Events.SegmentLoaded,t,s);const i=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(i),this.settings.consumeOnly||this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(i))},this.onSegmentError=async(t,e,s)=>{if(this.debugSegments("segment error",t.id,t.url,s,e),this.emit(o.Events.SegmentError,t,e,s),void 0!==this.masterSwarmId){const t=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(t)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(t))}},this.onSegmentSize=async(t,e)=>{this.debugSegments("segment size",t.id,e),this.emit(o.Events.SegmentSize,t,e)},this.getStreamSwarmId=t=>void 0===t.streamId?t.masterSwarmId:"".concat(t.masterSwarmId,"+").concat(t.streamId),this.createSegmentsMap=t=>{const e={},s=(t,s)=>{const i=this.getStreamSwarmId(t),n=t.sequence;let a=e[i];void 0===a&&(a=["",[]],e[i]=a);const r=a[1];a[0]+=0===r.length?n:"|".concat(n),r.push(s)};for(const e of t.values())s(e.segment,h.MediaPeerSegmentStatus.Loaded);for(const t of this.httpManager.getActiveDownloads().values())s(t.segment,h.MediaPeerSegmentStatus.LoadingByHttp);return e},this.onPeerConnect=async t=>{this.emit(o.Events.PeerConnect,t),this.settings.consumeOnly||void 0===this.masterSwarmId||this.p2pManager.sendSegmentsMap(t.id,this.createSegmentsMap(await this.segmentsStorage.getSegmentsMap(this.masterSwarmId)))},this.onPeerClose=t=>{this.emit(o.Events.PeerClose,t)},this.onTrackerUpdate=async t=>{if(this.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==t.incomplete&&t.incomplete<=1&&(this.debugSegments("cancel initial HTTP download timeout - no peers"),this.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==this.masterSwarmId)){const t=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(t)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(t))}},this.cleanSegmentsStorage=async()=>void 0!==this.masterSwarmId&&this.segmentsStorage.clean(this.masterSwarmId,(t=>void 0!==this.segmentsQueue.find((e=>e.id===t)))),this.now=()=>performance.now(),this.settings=Object.assign(Object.assign({},m),t);const{bufferedSegmentsCount:e}=t;"number"==typeof e&&(void 0===t.p2pDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=e),void 0===t.httpDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=e)),this.segmentsStorage=void 0===this.settings.segmentsStorage?new u.SegmentsMemoryStorage(this.settings):this.settings.segmentsStorage,this.debug("loader settings",this.settings),this.httpManager=this.createHttpManager(),this.httpManager.on("segment-start-load",(t=>this.onSegmentStartLoad("http",t))),this.httpManager.on("segment-loaded",this.onSegmentLoaded),this.httpManager.on("segment-error",this.onSegmentError),this.httpManager.on("segment-size",this.onSegmentSize),this.httpManager.on("bytes-downloaded",((t,e)=>{this.onPieceBytesDownloaded("http",t,e)})),this.p2pManager=this.createP2PManager(),this.p2pManager.on("segment-start-load",(t=>this.onSegmentStartLoad("p2p",t))),this.p2pManager.on("segment-loaded",this.onSegmentLoaded),this.p2pManager.on("segment-error",this.onSegmentError),this.p2pManager.on("segment-size",this.onSegmentSize),this.p2pManager.on("peer-data-updated",(async()=>{if(void 0===this.masterSwarmId)return;const t=await this.segmentsStorage.getSegmentsMap(this.masterSwarmId);this.processSegmentsQueue(t)&&!this.settings.consumeOnly&&this.p2pManager.sendSegmentsMapToAll(this.createSegmentsMap(t))})),this.p2pManager.on("bytes-downloaded",((t,e,s)=>this.onPieceBytesDownloaded("p2p",t,e,s))),this.p2pManager.on("bytes-uploaded",((t,e,s)=>this.onPieceBytesUploaded("p2p",t,e,s))),this.p2pManager.on("peer-connected",this.onPeerConnect),this.p2pManager.on("peer-closed",this.onPeerClose),this.p2pManager.on("tracker-update",this.onTrackerUpdate)}}e.HybridLoader=c,c.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},7350:function(t,e,s){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),n=this&&this.__exportStar||function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||i(e,t,s)};Object.defineProperty(e,"__esModule",{value:!0}),e.version=void 0,e.version="0.6.2",n(s(9979),e),n(s(223),e)},9979:(t,e)=>{"use strict";var s;Object.defineProperty(e,"__esModule",{value:!0}),e.Events=void 0,(s=e.Events||(e.Events={})).SegmentLoaded="segment_loaded",s.SegmentError="segment_error",s.SegmentSize="segment_size",s.SegmentAbort="segment_abort",s.SegmentStartLoad="segment_start_load",s.PeerConnect="peer_connect",s.PeerClose="peer_close",s.PieceBytesDownloaded="piece_bytes_downloaded",s.PieceBytesUploaded="piece_bytes_uploaded"},4136:function(t,e,s){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.MediaPeer=e.MediaPeerSegmentStatus=void 0;const n=i(s(7642)),a=s(2236),r=s(9731);var o,d;!function(t){t[t.SegmentData=0]="SegmentData",t[t.SegmentAbsent=1]="SegmentAbsent",t[t.SegmentsMap=2]="SegmentsMap",t[t.SegmentRequest=3]="SegmentRequest",t[t.CancelSegmentRequest=4]="CancelSegmentRequest"}(o||(o={})),function(t){t[t.Loaded=0]="Loaded",t[t.LoadingByHttp=1]="LoadingByHttp"}(d=e.MediaPeerSegmentStatus||(e.MediaPeerSegmentStatus={}));class g{constructor(t,e){this.id=t,this.size=e,this.bytesDownloaded=0,this.pieces=[]}}e.MediaPeer=class extends r.STEEmitter{constructor(t,e){super(),this.peer=t,this.settings=e,this.remoteAddress="",this.downloadingSegmentId=null,this.downloadingSegment=null,this.segmentsMap=new Map,this.debug=n.default("p2pml:media-peer"),this.timer=null,this.onPeerConnect=()=>{this.debug("peer connect",this.id,this),this.remoteAddress=this.peer.remoteAddress,this.emit("connect",this)},this.onPeerClose=()=>{this.debug("peer close",this.id,this),this.terminateSegmentRequest(),this.emit("close",this)},this.onPeerError=t=>{this.debug("peer error",this.id,t,this)},this.receiveSegmentPiece=t=>{if(!this.downloadingSegment)return void this.debug("peer segment not requested",this.id,this);this.downloadingSegment.bytesDownloaded+=t.byteLength,this.downloadingSegment.pieces.push(t);const e=this.downloadingSegment.id;if(this.emit("bytes-downloaded",this,e,t.byteLength),this.downloadingSegment.bytesDownloaded===this.downloadingSegment.size){const t=new Uint8Array(this.downloadingSegment.size);let s=0;for(const e of this.downloadingSegment.pieces)t.set(new Uint8Array(e),s),s+=e.byteLength;this.debug("peer segment download done",this.id,e,this),this.terminateSegmentRequest(),this.emit("segment-loaded",this,e,t.buffer)}else this.downloadingSegment.bytesDownloaded>this.downloadingSegment.size&&(this.debug("peer segment download bytes mismatch",this.id,e,this),this.terminateSegmentRequest(),this.emit("segment-error",this,e,"Too many bytes received for segment"))},this.getJsonCommand=t=>{const e=new Uint8Array(t);if(123===e[0]&&34===e[1]&&125===e[t.byteLength-1])try{return JSON.parse((new TextDecoder).decode(t))}catch(t){return null}return null},this.onPeerData=t=>{const e=this.getJsonCommand(t);if(null!==e){if(this.downloadingSegment){this.debug("peer segment download is interrupted by a command",this.id,this);const t=this.downloadingSegment.id;return this.terminateSegmentRequest(),void this.emit("segment-error",this,t,"Segment download is interrupted by a command")}switch(this.debug("peer receive command",this.id,e,this),e.c){case o.SegmentsMap:this.segmentsMap=this.createSegmentsMap(e.m),this.emit("data-updated");break;case o.SegmentRequest:this.emit("segment-request",this,e.i);break;case o.SegmentData:this.downloadingSegmentId&&this.downloadingSegmentId===e.i&&"number"==typeof e.s&&e.s>=0&&(this.downloadingSegment=new g(e.i,e.s),this.emit("segment-start-load",this.downloadingSegment.id),this.emit("segment-size",this.downloadingSegment.id,this.downloadingSegment.size),this.cancelResponseTimeoutTimer());break;case o.SegmentAbsent:this.downloadingSegmentId&&this.downloadingSegmentId===e.i&&(this.terminateSegmentRequest(),this.segmentsMap.delete(e.i),this.emit("segment-absent",this,e.i))}}else this.receiveSegmentPiece(t)},this.createSegmentsMap=t=>{if(!(t instanceof Object))return new Map;const e=new Map;for(const s of Object.keys(t)){const i=t[s];if(!(i instanceof Array&&2===i.length&&"string"==typeof i[0]&&i[1]instanceof Array))return new Map;const n=i[0].split("|"),a=i[1];if(n.length!==a.length)return new Map;for(let t=0;t<n.length;t++){const i=a[t];if("number"!=typeof i||void 0===d[i])return new Map;e.set("".concat(s,"+").concat(n[t]),i)}}return e},this.sendCommand=t=>{this.debug("peer send command",this.id,t,this),this.peer.write(JSON.stringify(t))},this.destroy=()=>{this.debug("peer destroy",this.id,this),this.terminateSegmentRequest(),this.peer.destroy()},this.getDownloadingSegmentId=()=>this.downloadingSegmentId,this.getSegmentsMap=()=>this.segmentsMap,this.sendSegmentsMap=t=>{this.sendCommand({c:o.SegmentsMap,m:t})},this.sendSegmentData=(t,e)=>{this.sendCommand({c:o.SegmentData,i:t,s:e.byteLength});let s=e.byteLength;for(;s>0;){const t=s>=this.settings.webRtcMaxMessageSize?this.settings.webRtcMaxMessageSize:s,i=a.Buffer.from(e,e.byteLength-s,t);this.peer.write(i),s-=t}this.emit("bytes-uploaded",this,t,e.byteLength)},this.sendSegmentAbsent=t=>{this.sendCommand({c:o.SegmentAbsent,i:t})},this.requestSegment=t=>{if(this.downloadingSegmentId)throw new Error("A segment is already downloading: "+this.downloadingSegmentId);this.sendCommand({c:o.SegmentRequest,i:t}),this.downloadingSegmentId=t,this.runResponseTimeoutTimer()},this.cancelSegmentRequest=()=>{let t;if(this.downloadingSegmentId){const e=this.downloadingSegmentId;t=this.downloadingSegment?this.downloadingSegment.pieces:void 0,this.terminateSegmentRequest(),this.sendCommand({c:o.CancelSegmentRequest,i:e})}return t},this.runResponseTimeoutTimer=()=>{this.timer=setTimeout((()=>{if(this.timer=null,!this.downloadingSegmentId)return;const t=this.downloadingSegmentId;this.cancelSegmentRequest(),this.emit("segment-timeout",this,t)}),this.settings.p2pSegmentDownloadTimeout)},this.cancelResponseTimeoutTimer=()=>{this.timer&&(clearTimeout(this.timer),this.timer=null)},this.terminateSegmentRequest=()=>{this.downloadingSegmentId=null,this.downloadingSegment=null,this.cancelResponseTimeoutTimer()},this.peer.on("connect",this.onPeerConnect),this.peer.on("close",this.onPeerClose),this.peer.on("error",this.onPeerError),this.peer.on("data",this.onPeerData),this.id=t.id}}},9045:function(t,e,s){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.P2PMediaManager=void 0;const n=i(s(7642)),a=i(s(5731)),r=s(2236),o=i(s(599)),d=s(9731),g=s(4136),h=s(7350).version.replace(/\d*./g,(t=>"0".concat(parseInt(t,10)%100).slice(-2))).slice(0,4),l="-WW".concat(h,"-");class u{constructor(t,e){this.peerId=t,this.segment=e}}e.P2PMediaManager=class extends d.STEEmitter{constructor(t,e){super(),this.segmentsStorage=t,this.settings=e,this.trackerClient=null,this.peers=new Map,this.peerCandidates=new Map,this.peerSegmentRequests=new Map,this.streamSwarmId=null,this.debug=n.default("p2pml:p2p-media-manager"),this.pendingTrackerClient=null,this.getPeers=()=>this.peers,this.getPeerId=()=>r.Buffer.from(this.peerId).toString("hex"),this.setStreamSwarmId=(t,e)=>{if(this.streamSwarmId===t)return;this.destroy(!0),this.streamSwarmId=t,this.masterSwarmId=e,this.debug("stream swarm ID",this.streamSwarmId),this.pendingTrackerClient={isDestroyed:!1};const s=this.pendingTrackerClient,i=(new o.default).update("".concat(2).concat(this.streamSwarmId)).digest();s.isDestroyed?null!==this.trackerClient&&(this.trackerClient.destroy(),this.trackerClient=null):(this.pendingTrackerClient=null,this.createClient(i))},this.createClient=t=>{if(!this.settings.useP2P)return;const e={infoHash:r.Buffer.from(t,0,20),peerId:r.Buffer.from(this.peerId,0,20),announce:this.settings.trackerAnnounce,rtcConfig:this.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:this.settings.peerRequestsPerAnnounce})};let s=this.trackerClient;this.trackerClient=new a.default(e),this.trackerClient.on("error",this.onTrackerError),this.trackerClient.on("warning",this.onTrackerWarning),this.trackerClient.on("update",this.onTrackerUpdate),this.trackerClient.on("peer",this.onTrackerPeer),this.trackerClient.start(),null!==s&&(s.destroy(),s=null)},this.onTrackerError=t=>{this.debug("tracker error",t)},this.onTrackerWarning=t=>{this.debug("tracker warning",t)},this.onTrackerUpdate=t=>{this.debug("tracker update",t),this.emit("tracker-update",t)},this.onTrackerPeer=t=>{if(this.debug("tracker peer",t.id,t),this.peers.has(t.id))return this.debug("tracker peer already connected",t.id,t),void t.destroy();const e=new g.MediaPeer(t,this.settings);e.on("connect",this.onPeerConnect),e.on("close",this.onPeerClose),e.on("data-updated",this.onPeerDataUpdated),e.on("segment-request",this.onSegmentRequest),e.on("segment-loaded",this.onSegmentLoaded),e.on("segment-absent",this.onSegmentAbsent),e.on("segment-error",this.onSegmentError),e.on("segment-size",this.onSegmentSize),e.on("segment-start-load",this.onSegmentStartLoad),e.on("segment-timeout",this.onSegmentTimeout),e.on("bytes-downloaded",this.onPieceBytesDownloaded),e.on("bytes-uploaded",this.onPieceBytesUploaded);let s=this.peerCandidates.get(e.id);s||(s=[],this.peerCandidates.set(e.id,s)),s.push(e)},this.download=t=>{if(this.isDownloading(t))return!1;const e=[];for(const s of this.peers.values())null===s.getDownloadingSegmentId()&&s.getSegmentsMap().get(t.id)===g.MediaPeerSegmentStatus.Loaded&&e.push(s);if(0===e.length)return!1;const s=e[Math.floor(Math.random()*e.length)];return s.requestSegment(t.id),this.peerSegmentRequests.set(t.id,new u(s.id,t)),!0},this.abort=t=>{let e;const s=this.peerSegmentRequests.get(t.id);if(s){const i=this.peers.get(s.peerId);i&&(e=i.cancelSegmentRequest()),this.peerSegmentRequests.delete(t.id)}return e},this.isDownloading=t=>this.peerSegmentRequests.has(t.id),this.getActiveDownloadsCount=()=>this.peerSegmentRequests.size,this.destroy=(t=!1)=>{this.streamSwarmId=null,this.trackerClient&&(this.trackerClient.stop(),t?(this.trackerClient.removeAllListeners("error"),this.trackerClient.removeAllListeners("warning"),this.trackerClient.removeAllListeners("update"),this.trackerClient.removeAllListeners("peer")):(this.trackerClient.destroy(),this.trackerClient=null)),this.pendingTrackerClient&&(this.pendingTrackerClient.isDestroyed=!0,this.pendingTrackerClient=null),this.peers.forEach((t=>t.destroy())),this.peers.clear(),this.peerSegmentRequests.clear();for(const t of this.peerCandidates.values())for(const e of t)e.destroy();this.peerCandidates.clear()},this.sendSegmentsMapToAll=t=>{this.peers.forEach((e=>e.sendSegmentsMap(t)))},this.sendSegmentsMap=(t,e)=>{const s=this.peers.get(t);s&&s.sendSegmentsMap(e)},this.getOverallSegmentsMap=()=>{const t=new Map;for(const e of this.peers.values())for(const[s,i]of e.getSegmentsMap())i===g.MediaPeerSegmentStatus.Loaded?t.set(s,g.MediaPeerSegmentStatus.Loaded):t.get(s)||t.set(s,g.MediaPeerSegmentStatus.LoadingByHttp);return t},this.onPieceBytesDownloaded=(t,e,s)=>{const i=this.peerSegmentRequests.get(e);i&&this.emit("bytes-downloaded",i.segment,s,t.id)},this.onPieceBytesUploaded=(t,e,s)=>{const i=this.peerSegmentRequests.get(e);i&&this.emit("bytes-uploaded",i.segment,s,t.id)},this.onPeerConnect=t=>{if(this.peers.get(t.id))return this.debug("tracker peer already connected (in peer connect)",t.id,t),void t.destroy();this.peers.set(t.id,t);const e=this.peerCandidates.get(t.id);if(e){for(const s of e)s!==t&&s.destroy();this.peerCandidates.delete(t.id)}this.emit("peer-connected",{id:t.id,remoteAddress:t.remoteAddress})},this.onPeerClose=t=>{if(this.peers.get(t.id)!==t){const e=this.peerCandidates.get(t.id);if(!e)return;const s=e.indexOf(t);return-1!==s&&e.splice(s,1),void(0===e.length&&this.peerCandidates.delete(t.id))}for(const[e,s]of this.peerSegmentRequests)s.peerId===t.id&&this.peerSegmentRequests.delete(e);this.peers.delete(t.id),this.emit("peer-data-updated"),this.emit("peer-closed",t.id)},this.onPeerDataUpdated=()=>{this.emit("peer-data-updated")},this.onSegmentRequest=async(t,e)=>{if(void 0===this.masterSwarmId)return;const s=await this.segmentsStorage.getSegment(e,this.masterSwarmId);s&&s.data?t.sendSegmentData(e,s.data):t.sendSegmentAbsent(e)},this.onSegmentLoaded=async(t,e,s)=>{const i=this.peerSegmentRequests.get(e);if(!i)return;const n=i.segment;if(this.settings.segmentValidator)try{await this.settings.segmentValidator(Object.assign(Object.assign({},n),{data:s}),"p2p",t.id)}catch(s){return this.debug("segment validator failed",s),this.peerSegmentRequests.delete(e),this.emit("segment-error",n,s,t.id),void this.onPeerClose(t)}this.peerSegmentRequests.delete(e),this.emit("segment-loaded",n,s,t.id)},this.onSegmentAbsent=(t,e)=>{this.peerSegmentRequests.delete(e),this.emit("peer-data-updated")},this.onSegmentError=(t,e,s)=>{const i=this.peerSegmentRequests.get(e);i&&(this.peerSegmentRequests.delete(e),this.emit("segment-error",i.segment,s,t.id))},this.onSegmentSize=(t,e)=>{const s=this.peerSegmentRequests.get(t);s&&this.emit("segment-size",s.segment,e)},this.onSegmentStartLoad=(t,e)=>{const s=this.peerSegmentRequests.get(t);s&&this.emit("segment-start-load",s.segment,e)},this.onSegmentTimeout=(t,e)=>{const s=this.peerSegmentRequests.get(e);s&&(this.peerSegmentRequests.delete(e),t.destroy(),this.peers.delete(s.peerId)&&this.emit("peer-data-updated"))},this.peerId=e.useP2P?function(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let e=l;for(let s=0;s<20-l.length;s++)e+=t.charAt(Math.floor(Math.random()*t.length));return(new TextEncoder).encode(e).buffer}():new ArrayBuffer(0),this.debug.enabled&&this.debug("peer ID",this.getPeerId(),(new TextDecoder).decode(this.peerId))}}},9622:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SegmentsMemoryStorage=void 0,e.SegmentsMemoryStorage=class{constructor(t){this.settings=t,this.cache=new Map,this.storeSegment=async t=>{this.cache.set(t.id,{segment:t,lastAccessed:performance.now()})},this.getSegmentsMap=async()=>this.cache,this.getSegment=async t=>{const e=this.cache.get(t);if(void 0!==e)return e.lastAccessed=performance.now(),e.segment},this.hasSegment=async t=>this.cache.has(t),this.clean=async(t,e)=>{const s=[],i=[],n=performance.now();for(const t of this.cache.values())n-t.lastAccessed>this.settings.cachedSegmentExpiration?s.push(t.segment.id):i.push(t);let a=i.length-this.settings.cachedSegmentsCount;if(a>0){i.sort(((t,e)=>t.lastAccessed-e.lastAccessed));for(const t of i)if((void 0===e||!e(t.segment.id))&&(s.push(t.segment.id),a--,0===a))break}return s.forEach((t=>this.cache.delete(t))),s.length>0},this.destroy=async()=>{this.cache.clear()}}}},9731:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.STEEmitter=void 0;const i=s(4575);e.STEEmitter=class extends i.EventEmitter{constructor(){super(...arguments),this.on=(t,e)=>super.on(t,e),this.emit=(t,...e)=>super.emit(t,...e)}}},1591:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.byteRangeToString=e.compareByteRanges=e.getByteRange=void 0,e.getByteRange=function(t){return t.rangeEnd&&void 0!==t.rangeStart?{offset:t.rangeStart,length:t.rangeEnd-t.rangeStart}:void 0},e.compareByteRanges=function(t,e){return void 0===t?void 0===e:void 0!==e&&t.length===e.length&&t.offset===e.offset},e.byteRangeToString=function(t){if(void 0===t)return;const e=t.offset+t.length-1;return"bytes=".concat(t.offset,"-").concat(e)}},3993:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Engine=void 0;const i=s(4575),n=s(7350),a=s(9437),r=s(7136);e.Engine=class extends i.EventEmitter{constructor(t={}){super(),this.loader=new n.HybridLoader(t.loader),this.segmentManager=new a.SegmentManager(this.loader,t.segments),Object.keys(n.Events).map((t=>n.Events[t])).forEach((t=>this.loader.on(t,((...e)=>this.emit(t,...e)))))}static isSupported(){return n.HybridLoader.isSupported()}createLoaderClass(){var t;const e=this;return(t=class{constructor(){this.load=async(t,e,s)=>{this.context=t,this.callbacks=s,await this.impl.load(t,e,s)},this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context)},this.getResponseHeader=()=>{},this.impl=new r.HlsJsLoader(e.segmentManager),this.stats=this.impl.stats}}).getEngine=()=>e,t}async destroy(){await this.segmentManager.destroy()}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}setPlayingSegment(t,e,s,i){this.segmentManager.setPlayingSegment(t,e,s,i)}setPlayingSegmentByCurrentTime(t){this.segmentManager.setPlayingSegmentByCurrentTime(t)}}},7136:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HlsJsLoader=void 0;const i=s(7350),n=s(1591);class a{constructor(t){this.isLoaded=!1,this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.segmentManager=t}async load(t,e,s){if(a.updateStatsToStartLoading(this.stats),t.type)try{const e=await this.segmentManager.loadPlaylist(t.url);this.isLoaded=!0,this.successPlaylist(e,t,s)}catch(e){this.error(e,t,s)}else if(t.frag){const{loader:e}=this.segmentManager,r=n.getByteRange(t),o=e=>e.url===t.url&&e.range===n.byteRangeToString(r);let d=setInterval((()=>{a.updateStatsToStartLoading(this.stats)}),200);const g=(t,e)=>{o(t)&&(this.stats.total=e)};e.on(i.Events.SegmentSize,g);const h=(t,e,s)=>{o(e)&&(this.stats.loaded+=s)},l=(t,s)=>{d&&"http"===t&&o(s)&&(clearInterval(d),d=void 0,a.updateStatsToStartLoading(this.stats),e.on(i.Events.PieceBytesDownloaded,h))};e.on(i.Events.SegmentStartLoad,l);try{const n=await this.segmentManager.loadSegment(t.url,r),{content:a}=n;a&&(this.isLoaded=!0,setTimeout((()=>this.successSegment(a,t,s)),0))}catch(e){setTimeout((()=>this.error(e,t,s)),0)}finally{clearInterval(d),e.off(i.Events.SegmentStartLoad,l),e.off(i.Events.SegmentSize,g),e.off(i.Events.PieceBytesDownloaded,h)}}else console.warn("Unknown load request",t)}abort(t,e){if(this.isLoaded)return;this.segmentManager.abortSegment(t.url,n.getByteRange(t)),this.stats.aborted=!0;const s=null==e?void 0:e.onAbort;s&&s(this.stats,t,void 0)}successPlaylist(t,e,s){const i=performance.now();this.stats.loading.end=i,this.stats.loaded=t.response.length,this.stats.total=t.response.length,s.onSuccess({url:t.responseURL,data:t.response},this.stats,e,void 0)}successSegment(t,e,s){const i=performance.now();this.stats.loading.end=i,this.stats.loaded=t.byteLength,this.stats.total=t.byteLength,s.onProgress&&s.onProgress(this.stats,e,t,void 0),s.onSuccess({url:e.url,data:t},this.stats,e,void 0)}error(t,e,s){s.onError(t,e,void 0)}static updateStatsToStartLoading(t){const e=performance.now();t.loading.start=e,t.loading.first=e}}e.HlsJsLoader=a},569:function(t,e,s){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,s,i){void 0===i&&(i=s),Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[s]}})}:function(t,e,s,i){void 0===i&&(i=s),t[i]=e[s]}),n=this&&this.__exportStar||function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||i(e,t,s)};function a(t){t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&r(t,t.config.loader.getEngine())}function r(t,e){t.on("hlsFragChanged",((t,s)=>{const i=s.frag;e.setPlayingSegment(i.url,2!==i.byteRange.length?void 0:{offset:i.byteRange[0],length:i.byteRange[1]-i.byteRange[0]},i.start,i.duration)})),t.on("hlsDestroying",(async()=>{await e.destroy()})),t.on("hlsError",((s,i)=>{if("bufferStalledError"===i.details){const s=void 0===t.media?t.el_:t.media;s&&e.setPlayingSegmentByCurrentTime(s.currentTime)}}))}Object.defineProperty(e,"__esModule",{value:!0}),e.initJwPlayer=e.initMediaElementJsPlayer=e.initVideoJsHlsJsPlugin=e.initVideoJsContribHlsJsPlayer=e.initFlowplayerHlsJsPlayer=e.initClapprPlayer=e.initHlsJsPlayer=e.version=void 0,e.version="0.6.2",n(s(3993),e),n(s(9437),e),e.initHlsJsPlayer=a,e.initClapprPlayer=function(t){t.on("play",(()=>{const e=t.core.getCurrentPlayback();e._hls&&!e._hls._p2pm_linitialized&&(e._hls._p2pm_linitialized=!0,a(t.core.getCurrentPlayback()._hls))}))},e.initFlowplayerHlsJsPlayer=function(t){t.on("ready",(()=>{var e;return a(null!==(e=t.engine.hlsjs)&&void 0!==e?e:t.engine.hls)}))},e.initVideoJsContribHlsJsPlayer=function(t){t.ready((()=>{const e=t.tech_.options_;e&&e.hlsjsConfig&&e.hlsjsConfig.loader&&"function"==typeof e.hlsjsConfig.loader.getEngine&&r(t.tech_,e.hlsjsConfig.loader.getEngine())}))},e.initVideoJsHlsJsPlugin=function(){null!=videojs&&null!=videojs.Html5Hlsjs&&videojs.Html5Hlsjs.addHook("beforeinitialize",((t,e)=>{e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine&&r(e,e.config.loader.getEngine())}))},e.initMediaElementJsPlayer=function(t){t.addEventListener("hlsFragChanged",(e=>{const s=t.hlsPlayer;if(s&&s.config&&s.config.loader&&"function"==typeof s.config.loader.getEngine){const t=s.config.loader.getEngine();if(e.data&&e.data.length>1){const s=e.data[1].frag;t.setPlayingSegment(s.url,2!==s.byteRange.length?void 0:{offset:s.byteRange[0],length:s.byteRange[1]-s.byteRange[0]},s.start,s.duration)}}})),t.addEventListener("hlsDestroying",(async()=>{const e=t.hlsPlayer;if(e&&e.config&&e.config.loader&&"function"==typeof e.config.loader.getEngine){const t=e.config.loader.getEngine();await t.destroy()}})),t.addEventListener("hlsError",(e=>{const s=t.hlsPlayer;s&&s.config&&s.config.loader&&"function"==typeof s.config.loader.getEngine&&void 0!==e.data&&"bufferStalledError"===e.data.details&&s.config.loader.getEngine().setPlayingSegmentByCurrentTime(s.media.currentTime)}))},e.initJwPlayer=function(t,e){const s=setInterval((()=>{t.hls&&t.hls.config&&(clearInterval(s),Object.assign(t.hls.config,e),a(t.hls))}),200)}},9437:(t,e,s)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SegmentManager=void 0;const i=s(7350),n=s(6026),a=s(1591),r={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};e.SegmentManager=class{constructor(t,e={}){this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.playQueue=[],this.onSegmentLoaded=t=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&a.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onSuccess(t.data.slice(0),t.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(t,e)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&a.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onError(e),this.segmentRequest=null)},this.onSegmentAbort=t=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&a.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},r),e),this.loader=t,this.loader.on(i.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(i.Events.SegmentError,this.onSegmentError),this.loader.on(i.Events.SegmentAbort,this.onSegmentAbort)}getSettings(){return this.settings}processPlaylist(t,e,s){const i=new n.Parser;i.push(e),i.end();const a=new o(t,s,i.manifest);if(a.manifest.playlists){this.masterPlaylist=a;for(const[t,e]of this.variantPlaylists){const{streamSwarmId:s,found:i,index:n}=this.getStreamSwarmId(e.requestUrl);i?(e.streamSwarmId=s,e.streamId="V"+n.toString()):this.variantPlaylists.delete(t)}}else{const{streamSwarmId:e,found:s,index:i}=this.getStreamSwarmId(t);(s||null===this.masterPlaylist)&&(a.streamSwarmId=e,a.streamId=null===this.masterPlaylist?void 0:"V"+i.toString(),this.variantPlaylists.set(t,a),this.updateSegments())}}async loadPlaylist(t){const e=this.settings.assetsStorage;let s;if(void 0!==e){let i;i=this.getMasterSwarmId(),void 0===i&&(i=t.split("?")[0]);const n=await e.getAsset(t,void 0,i);void 0!==n?s={responseURL:n.responseUri,response:n.data}:(s=await this.loadContent(t,"text"),e.storeAsset({masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:t,masterSwarmId:i,requestUri:t,responseUri:s.responseURL,data:s.response}))}else s=await this.loadContent(t,"text");return this.processPlaylist(t,s.response,s.responseURL),s}async loadSegment(t,e){var s;const i=this.getSegmentLocation(t,e),n=a.byteRangeToString(e);if(!i){let e;const i=this.settings.assetsStorage;if(void 0!==i){let a,r=null===(s=this.masterPlaylist)||void 0===s?void 0:s.requestUrl;if(a=this.getMasterSwarmId(),void 0===a&&1===this.variantPlaylists.size){const t=this.variantPlaylists.values().next();t.done||(a=t.value.requestUrl.split("?")[0])}if(void 0===r&&1===this.variantPlaylists.size){const t=this.variantPlaylists.values().next();t.done||(r=t.value.requestUrl)}if(void 0!==a&&void 0!==r){const s=await i.getAsset(t,n,a);if(void 0!==s)e=s.data;else{const s=await this.loadContent(t,"arraybuffer",n);e=s.response,i.storeAsset({masterManifestUri:r,masterSwarmId:a,requestUri:t,requestRange:n,responseUri:s.responseURL,data:e})}}}return void 0===e&&(e=(await this.loadContent(t,"arraybuffer",n)).response),{content:e,downloadBandwidth:0}}const r=(i.playlist.manifest.mediaSequence?i.playlist.manifest.mediaSequence:0)+i.segmentIndex;this.playQueue.length>0&&this.playQueue[this.playQueue.length-1].segmentSequence!==r-1&&(this.playQueue=[]),this.segmentRequest&&this.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const o=new Promise(((s,n)=>{this.segmentRequest=new d(t,e,r,i.playlist.requestUrl,((t,e)=>s({content:t,downloadBandwidth:e})),(t=>n(t)))}));return this.playQueue.push({segmentUrl:t,segmentByteRange:e,segmentSequence:r}),this.loadSegments(i.playlist,i.segmentIndex,!0),o}setPlayingSegment(t,e,s,i){const n=this.playQueue.findIndex((s=>s.segmentUrl===t&&a.compareByteRanges(s.segmentByteRange,e)));n>=0&&(this.playQueue=this.playQueue.slice(n),this.playQueue[0].playPosition={start:s,duration:i},this.updateSegments())}setPlayingSegmentByCurrentTime(t){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const e=this.playQueue[0].playPosition;e.start+e.duration-t<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}abortSegment(t,e){this.segmentRequest&&this.segmentRequest.segmentUrl===t&&a.compareByteRanges(this.segmentRequest.segmentByteRange,e)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}async destroy(){this.segmentRequest&&(this.segmentRequest.onError("Loading aborted: object destroyed"),this.segmentRequest=null),this.masterPlaylist=null,this.variantPlaylists.clear(),this.playQueue=[],void 0!==this.settings.assetsStorage&&await this.settings.assetsStorage.destroy(),await this.loader.destroy()}updateSegments(){if(!this.segmentRequest)return;const t=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);t&&this.loadSegments(t.playlist,t.segmentIndex,!1)}getSegmentLocation(t,e){for(const s of this.variantPlaylists.values()){const i=s.getSegmentIndex(t,e);if(i>=0)return{playlist:s,segmentIndex:i}}}async loadSegments(t,e,s){var i;const n=[],r=t.manifest.segments,o=null!==(i=t.manifest.mediaSequence)&&void 0!==i?i:0;let d=null,g=Math.max(0,this.playQueue.length-1);const h=this.getMasterSwarmId();for(let i=e;i<r.length&&n.length<this.settings.forwardSegmentCount;++i){const e=t.manifest.segments[i],r=t.getSegmentAbsoluteUrl(e.uri),l=e.byterange,u=this.getSegmentId(t,o+i);n.push({id:u,url:r,masterSwarmId:void 0!==h?h:t.streamSwarmId,masterManifestUri:null!==this.masterPlaylist?this.masterPlaylist.requestUrl:t.requestUrl,streamId:t.streamId,sequence:(o+i).toString(),range:a.byteRangeToString(l),priority:g++}),s&&!d&&(d=u)}if(this.loader.load(n,t.streamSwarmId),d){const t=await this.loader.getSegment(d);t&&this.onSegmentLoaded(t)}}getSegmentId(t,e){return"".concat(t.streamSwarmId,"+").concat(e)}getMasterSwarmId(){const t=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==t?t:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}getStreamSwarmId(t){const e=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&e)for(let s=0;s<this.masterPlaylist.manifest.playlists.length;++s)if(new URL(this.masterPlaylist.manifest.playlists[s].uri,this.masterPlaylist.responseUrl).toString()===t)return{streamSwarmId:"".concat(e,"+V").concat(s),found:!0,index:s};return{streamSwarmId:null!=e?e:t.split("?")[0],found:!1,index:-1}}async loadContent(t,e,s){return new Promise(((i,n)=>{const a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType=e,s&&a.setRequestHeader("Range",s),a.addEventListener("readystatechange",(()=>{4===a.readyState&&(a.status>=200&&a.status<300?i(a):n(a.statusText))}));const r=this.loader.getSettings().xhrSetup;r&&r(a,t),a.send()}))}};class o{constructor(t,e,s){this.requestUrl=t,this.responseUrl=e,this.manifest=s,this.streamSwarmId=""}getSegmentIndex(t,e){for(let s=0;s<this.manifest.segments.length;++s){const i=this.manifest.segments[s];if(t===this.getSegmentAbsoluteUrl(i.uri)&&a.compareByteRanges(i.byterange,e))return s}return-1}getSegmentAbsoluteUrl(t){return new URL(t,this.responseUrl).toString()}}class d{constructor(t,e,s,i,n,a){this.segmentUrl=t,this.segmentByteRange=e,this.segmentSequence=s,this.playlistRequestUrl=i,this.onSuccess=n,this.onError=a}}},6026:(t,e,s)=>{"use strict";function i(t,e){return(i=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function n(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,i(t,e)}s.r(e),s.d(e,{LineStream:()=>l,ParseStream:()=>p,Parser:()=>y});var a=function(){function t(){this.listeners={}}var e=t.prototype;return e.on=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},e.off=function(t,e){if(!this.listeners[t])return!1;var s=this.listeners[t].indexOf(e);return this.listeners[t]=this.listeners[t].slice(0),this.listeners[t].splice(s,1),s>-1},e.trigger=function(t){var e=this.listeners[t];if(e)if(2===arguments.length)for(var s=e.length,i=0;i<s;++i)e[i].call(this,arguments[1]);else for(var n=Array.prototype.slice.call(arguments,1),a=e.length,r=0;r<a;++r)e[r].apply(this,n)},e.dispose=function(){this.listeners={}},e.pipe=function(t){this.on("data",(function(e){t.push(e)}))},t}();function r(){return(r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(t[i]=s[i])}return t}).apply(this,arguments)}var o=s(7688),d=s.n(o),g=s(2236).Buffer;function h(t){for(var e,s=(e=t,d().atob?d().atob(e):g.from(e,"base64").toString("binary")),i=new Uint8Array(s.length),n=0;n<s.length;n++)i[n]=s.charCodeAt(n);return i}var l=function(t){function e(){var e;return(e=t.call(this)||this).buffer="",e}return n(e,t),e.prototype.push=function(t){var e;for(this.buffer+=t,e=this.buffer.indexOf("\n");e>-1;e=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,e)),this.buffer=this.buffer.substring(e+1)},e}(a),u=String.fromCharCode(9),m=function(t){var e=/([0-9.]*)?@?([0-9.]*)?/.exec(t||""),s={};return e[1]&&(s.length=parseInt(e[1],10)),e[2]&&(s.offset=parseInt(e[2],10)),s},c=function(t){for(var e,s=t.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),i={},n=s.length;n--;)""!==s[n]&&((e=/([^=]*)=(.*)/.exec(s[n]).slice(1))[0]=e[0].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^\s+|\s+$/g,""),e[1]=e[1].replace(/^['"](.*)['"]$/g,"$1"),i[e[0]]=e[1]);return i},p=function(t){function e(){var e;return(e=t.call(this)||this).customParsers=[],e.tagMappers=[],e}n(e,t);var s=e.prototype;return s.push=function(t){var e,s,i=this;0!==(t=t.trim()).length&&("#"===t[0]?this.tagMappers.reduce((function(e,s){var i=s(t);return i===t?e:e.concat([i])}),[t]).forEach((function(t){for(var n=0;n<i.customParsers.length;n++)if(i.customParsers[n].call(i,t))return;if(0===t.indexOf("#EXT"))if(t=t.replace("\r",""),e=/^#EXTM3U/.exec(t))i.trigger("data",{type:"tag",tagType:"m3u"});else{if(e=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(t))return s={type:"tag",tagType:"inf"},e[1]&&(s.duration=parseFloat(e[1])),e[2]&&(s.title=e[2]),void i.trigger("data",s);if(e=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(t))return s={type:"tag",tagType:"targetduration"},e[1]&&(s.duration=parseInt(e[1],10)),void i.trigger("data",s);if(e=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(t))return s={type:"tag",tagType:"version"},e[1]&&(s.version=parseInt(e[1],10)),void i.trigger("data",s);if(e=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return s={type:"tag",tagType:"media-sequence"},e[1]&&(s.number=parseInt(e[1],10)),void i.trigger("data",s);if(e=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(t))return s={type:"tag",tagType:"discontinuity-sequence"},e[1]&&(s.number=parseInt(e[1],10)),void i.trigger("data",s);if(e=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(t))return s={type:"tag",tagType:"playlist-type"},e[1]&&(s.playlistType=e[1]),void i.trigger("data",s);if(e=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(t))return s=r(m(e[1]),{type:"tag",tagType:"byterange"}),void i.trigger("data",s);if(e=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(t))return s={type:"tag",tagType:"allow-cache"},e[1]&&(s.allowed=!/NO/.test(e[1])),void i.trigger("data",s);if(e=/^#EXT-X-MAP:?(.*)$/.exec(t)){if(s={type:"tag",tagType:"map"},e[1]){var a=c(e[1]);a.URI&&(s.uri=a.URI),a.BYTERANGE&&(s.byterange=m(a.BYTERANGE))}i.trigger("data",s)}else if(e=/^#EXT-X-STREAM-INF:?(.*)$/.exec(t)){if(s={type:"tag",tagType:"stream-inf"},e[1]){if(s.attributes=c(e[1]),s.attributes.RESOLUTION){var o=s.attributes.RESOLUTION.split("x"),d={};o[0]&&(d.width=parseInt(o[0],10)),o[1]&&(d.height=parseInt(o[1],10)),s.attributes.RESOLUTION=d}s.attributes.BANDWIDTH&&(s.attributes.BANDWIDTH=parseInt(s.attributes.BANDWIDTH,10)),s.attributes["PROGRAM-ID"]&&(s.attributes["PROGRAM-ID"]=parseInt(s.attributes["PROGRAM-ID"],10))}i.trigger("data",s)}else{if(e=/^#EXT-X-MEDIA:?(.*)$/.exec(t))return s={type:"tag",tagType:"media"},e[1]&&(s.attributes=c(e[1])),void i.trigger("data",s);if(e=/^#EXT-X-ENDLIST/.exec(t))i.trigger("data",{type:"tag",tagType:"endlist"});else if(e=/^#EXT-X-DISCONTINUITY/.exec(t))i.trigger("data",{type:"tag",tagType:"discontinuity"});else{if(e=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(t))return s={type:"tag",tagType:"program-date-time"},e[1]&&(s.dateTimeString=e[1],s.dateTimeObject=new Date(e[1])),void i.trigger("data",s);if(e=/^#EXT-X-KEY:?(.*)$/.exec(t))return s={type:"tag",tagType:"key"},e[1]&&(s.attributes=c(e[1]),s.attributes.IV&&("0x"===s.attributes.IV.substring(0,2).toLowerCase()&&(s.attributes.IV=s.attributes.IV.substring(2)),s.attributes.IV=s.attributes.IV.match(/.{8}/g),s.attributes.IV[0]=parseInt(s.attributes.IV[0],16),s.attributes.IV[1]=parseInt(s.attributes.IV[1],16),s.attributes.IV[2]=parseInt(s.attributes.IV[2],16),s.attributes.IV[3]=parseInt(s.attributes.IV[3],16),s.attributes.IV=new Uint32Array(s.attributes.IV))),void i.trigger("data",s);if(e=/^#EXT-X-START:?(.*)$/.exec(t))return s={type:"tag",tagType:"start"},e[1]&&(s.attributes=c(e[1]),s.attributes["TIME-OFFSET"]=parseFloat(s.attributes["TIME-OFFSET"]),s.attributes.PRECISE=/YES/.test(s.attributes.PRECISE)),void i.trigger("data",s);if(e=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(t))return(s={type:"tag",tagType:"cue-out-cont"}).data=e[1]?e[1]:"",void i.trigger("data",s);if(e=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(t))return(s={type:"tag",tagType:"cue-out"}).data=e[1]?e[1]:"",void i.trigger("data",s);if(e=/^#EXT-X-CUE-IN:?(.*)?$/.exec(t))return(s={type:"tag",tagType:"cue-in"}).data=e[1]?e[1]:"",void i.trigger("data",s);if((e=/^#EXT-X-SKIP:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"skip"}).attributes=c(e[1]),s.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(s.attributes["SKIPPED-SEGMENTS"]=parseInt(s.attributes["SKIPPED-SEGMENTS"],10)),s.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(s.attributes["RECENTLY-REMOVED-DATERANGES"]=s.attributes["RECENTLY-REMOVED-DATERANGES"].split(u)),void i.trigger("data",s);if((e=/^#EXT-X-PART:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"part"}).attributes=c(e[1]),["DURATION"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),["INDEPENDENT","GAP"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=/YES/.test(s.attributes[t]))})),s.attributes.hasOwnProperty("BYTERANGE")&&(s.attributes.byterange=m(s.attributes.BYTERANGE)),void i.trigger("data",s);if((e=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"server-control"}).attributes=c(e[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=/YES/.test(s.attributes[t]))})),void i.trigger("data",s);if((e=/^#EXT-X-PART-INF:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"part-inf"}).attributes=c(e[1]),["PART-TARGET"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseFloat(s.attributes[t]))})),void i.trigger("data",s);if((e=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"preload-hint"}).attributes=c(e[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach((function(t){if(s.attributes.hasOwnProperty(t)){s.attributes[t]=parseInt(s.attributes[t],10);var e="BYTERANGE-LENGTH"===t?"length":"offset";s.attributes.byterange=s.attributes.byterange||{},s.attributes.byterange[e]=s.attributes[t],delete s.attributes[t]}})),void i.trigger("data",s);if((e=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(t))&&e[1])return(s={type:"tag",tagType:"rendition-report"}).attributes=c(e[1]),["LAST-MSN","LAST-PART"].forEach((function(t){s.attributes.hasOwnProperty(t)&&(s.attributes[t]=parseInt(s.attributes[t],10))})),void i.trigger("data",s);i.trigger("data",{type:"tag",data:t.slice(4)})}}}else i.trigger("data",{type:"comment",text:t.slice(1)})})):this.trigger("data",{type:"uri",uri:t}))},s.addParser=function(t){var e=this,s=t.expression,i=t.customType,n=t.dataParser,a=t.segment;"function"!=typeof n&&(n=function(t){return t}),this.customParsers.push((function(t){if(s.exec(t))return e.trigger("data",{type:"custom",data:n(t),customType:i,segment:a}),!0}))},s.addTagMapper=function(t){var e=t.expression,s=t.map;this.tagMappers.push((function(t){return e.test(t)?s(t):t}))},e}(a),f=function(t){var e={};return Object.keys(t).forEach((function(s){var i;e[(i=s,i.toLowerCase().replace(/-(\w)/g,(function(t){return t[1].toUpperCase()})))]=t[s]})),e},S=function(t){var e=t.serverControl,s=t.targetDuration,i=t.partTargetDuration;if(e){var n="#EXT-X-SERVER-CONTROL",a="holdBack",r="partHoldBack",o=s&&3*s,d=i&&2*i;s&&!e.hasOwnProperty(a)&&(e[a]=o,this.trigger("info",{message:n+" defaulting HOLD-BACK to targetDuration * 3 ("+o+")."})),o&&e[a]<o&&(this.trigger("warn",{message:n+" clamping HOLD-BACK ("+e[a]+") to targetDuration * 3 ("+o+")"}),e[a]=o),i&&!e.hasOwnProperty(r)&&(e[r]=3*i,this.trigger("info",{message:n+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+e[r]+")."})),i&&e[r]<d&&(this.trigger("warn",{message:n+" clamping PART-HOLD-BACK ("+e[r]+") to partTargetDuration * 2 ("+d+")."}),e[r]=d)}},y=function(t){function e(){var e;(e=t.call(this)||this).lineStream=new l,e.parseStream=new p,e.lineStream.pipe(e.parseStream);var s,i,n=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(e),a=[],o={},d=!1,g=function(){},u={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},m=0;e.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var c=0,y=0;return e.on("end",(function(){o.uri||!o.parts&&!o.preloadHints||(!o.map&&s&&(o.map=s),!o.key&&i&&(o.key=i),o.timeline||"number"!=typeof m||(o.timeline=m),e.manifest.preloadSegment=o)})),e.parseStream.on("data",(function(t){var e,l;({tag:function(){({version:function(){t.version&&(this.manifest.version=t.version)},"allow-cache":function(){this.manifest.allowCache=t.allowed,"allowed"in t||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var e={};"length"in t&&(o.byterange=e,e.length=t.length,"offset"in t||(t.offset=c)),"offset"in t&&(o.byterange=e,e.offset=t.offset),c=e.offset+e.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),t.duration>0&&(o.duration=t.duration),0===t.duration&&(o.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=a},key:function(){if(t.attributes)if("NONE"!==t.attributes.METHOD)if(t.attributes.URI){if("com.apple.streamingkeydelivery"===t.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:t.attributes});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===t.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(t.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===t.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==t.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):t.attributes.KEYID&&"0x"===t.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:t.attributes.KEYFORMAT,keyId:t.attributes.KEYID.substring(2)},pssh:h(t.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));t.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),i={method:t.attributes.METHOD||"AES-128",uri:t.attributes.URI},void 0!==t.attributes.IV&&(i.iv=t.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else i=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(t.number)?this.manifest.mediaSequence=t.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+t.number})},"discontinuity-sequence":function(){isFinite(t.number)?(this.manifest.discontinuitySequence=t.number,m=t.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+t.number})},"playlist-type":function(){/VOD|EVENT/.test(t.playlistType)?this.manifest.playlistType=t.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+t.playlist})},map:function(){s={},t.uri&&(s.uri=t.uri),t.byterange&&(s.byterange=t.byterange),i&&(s.key=i)},"stream-inf":function(){this.manifest.playlists=a,this.manifest.mediaGroups=this.manifest.mediaGroups||u,t.attributes?(o.attributes||(o.attributes={}),r(o.attributes,t.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||u,t.attributes&&t.attributes.TYPE&&t.attributes["GROUP-ID"]&&t.attributes.NAME){var s=this.manifest.mediaGroups[t.attributes.TYPE];s[t.attributes["GROUP-ID"]]=s[t.attributes["GROUP-ID"]]||{},e=s[t.attributes["GROUP-ID"]],(l={default:/yes/i.test(t.attributes.DEFAULT)}).autoselect=!!l.default||/yes/i.test(t.attributes.AUTOSELECT),t.attributes.LANGUAGE&&(l.language=t.attributes.LANGUAGE),t.attributes.URI&&(l.uri=t.attributes.URI),t.attributes["INSTREAM-ID"]&&(l.instreamId=t.attributes["INSTREAM-ID"]),t.attributes.CHARACTERISTICS&&(l.characteristics=t.attributes.CHARACTERISTICS),t.attributes.FORCED&&(l.forced=/yes/i.test(t.attributes.FORCED)),e[t.attributes.NAME]=l}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){m+=1,o.discontinuity=!0,this.manifest.discontinuityStarts.push(a.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=t.dateTimeString,this.manifest.dateTimeObject=t.dateTimeObject),o.dateTimeString=t.dateTimeString,o.dateTimeObject=t.dateTimeObject},targetduration:function(){!isFinite(t.duration)||t.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+t.duration}):(this.manifest.targetDuration=t.duration,S.call(this,this.manifest))},start:function(){t.attributes&&!isNaN(t.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:t.attributes["TIME-OFFSET"],precise:t.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){o.cueOut=t.data},"cue-out-cont":function(){o.cueOutCont=t.data},"cue-in":function(){o.cueIn=t.data},skip:function(){this.manifest.skip=f(t.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",t.attributes,["SKIPPED-SEGMENTS"])},part:function(){var e=this;d=!0;var s=this.manifest.segments.length,i=f(t.attributes);o.parts=o.parts||[],o.parts.push(i),i.byterange&&(i.byterange.hasOwnProperty("offset")||(i.byterange.offset=y),y=i.byterange.offset+i.byterange.length),this.warnOnMissingAttributes_("#EXT-X-PART #"+(o.parts.length-1)+" for segment #"+s,t.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((function(t,s){t.hasOwnProperty("lastPart")||e.trigger("warn",{message:"#EXT-X-RENDITION-REPORT #"+s+" lacks required attribute(s): LAST-PART"})}))},"server-control":function(){var e=this.manifest.serverControl=f(t.attributes);e.hasOwnProperty("canBlockReload")||(e.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),S.call(this,this.manifest),e.canSkipDateranges&&!e.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint":function(){var e=this.manifest.segments.length,s=f(t.attributes),i=s.type&&"PART"===s.type;o.preloadHints=o.preloadHints||[],o.preloadHints.push(s),s.byterange&&(s.byterange.hasOwnProperty("offset")||(s.byterange.offset=i?y:0,i&&(y=s.byterange.offset+s.byterange.length)));var n=o.preloadHints.length-1;if(this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+n+" for segment #"+e,t.attributes,["TYPE","URI"]),s.type)for(var a=0;a<o.preloadHints.length-1;a++){var r=o.preloadHints[a];r.type&&r.type===s.type&&this.trigger("warn",{message:"#EXT-X-PRELOAD-HINT #"+n+" for segment #"+e+" has the same TYPE "+s.type+" as preload hint #"+a})}},"rendition-report":function(){var e=f(t.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(e);var s=this.manifest.renditionReports.length-1,i=["LAST-MSN","URI"];d&&i.push("LAST-PART"),this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+s,t.attributes,i)},"part-inf":function(){this.manifest.partInf=f(t.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",t.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),S.call(this,this.manifest)}}[t.tagType]||g).call(n)},uri:function(){o.uri=t.uri,a.push(o),this.manifest.targetDuration&&!("duration"in o)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),o.duration=this.manifest.targetDuration),i&&(o.key=i),o.timeline=m,s&&(o.map=s),y=0,o={}},comment:function(){},custom:function(){t.segment?(o.custom=o.custom||{},o.custom[t.customType]=t.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[t.customType]=t.data)}})[t.type].call(n)})),e}n(e,t);var s=e.prototype;return s.warnOnMissingAttributes_=function(t,e,s){var i=[];s.forEach((function(t){e.hasOwnProperty(t)||i.push(t)})),i.length&&this.trigger("warn",{message:t+" lacks required attribute(s): "+i.join(", ")})},s.push=function(t){this.lineStream.push(t)},s.end=function(){this.lineStream.push("\n"),this.trigger("end")},s.addParser=function(t){this.parseStream.addParser(t)},s.addTagMapper=function(t){this.parseStream.addTagMapper(t)},e}(a)},1998:(t,e,s)=>{var i=s(6086).Buffer;function n(t,e){this._block=i.alloc(t),this._finalSize=e,this._blockSize=t,this._len=0}n.prototype.update=function(t,e){"string"==typeof t&&(t=i.from(t,e=e||"utf8"));for(var s=this._block,n=this._blockSize,a=t.length,r=this._len,o=0;o<a;){for(var d=r%n,g=Math.min(a-o,n-d),h=0;h<g;h++)s[d+h]=t[o+h];o+=g,(r+=g)%n==0&&this._update(s)}return this._len+=a,this},n.prototype.digest=function(t){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var s=8*this._len;if(s<=4294967295)this._block.writeUInt32BE(s,this._blockSize-4);else{var i=(4294967295&s)>>>0;this._block.writeUInt32BE((s-i)/4294967296,this._blockSize-8),this._block.writeUInt32BE(i,this._blockSize-4)}this._update(this._block);var n=this._hash();return t?n.toString(t):n},n.prototype._update=function(){throw new Error("_update must be implemented by subclass")},t.exports=n},599:(t,e,s)=>{var i=s(4540),n=s(1998),a=s(6086).Buffer,r=[1518500249,1859775393,-1894007588,-899497514],o=new Array(80);function d(){this.init(),this._w=o,n.call(this,64,56)}function g(t){return t<<5|t>>>27}function h(t){return t<<30|t>>>2}function l(t,e,s,i){return 0===t?e&s|~e&i:2===t?e&s|e&i|s&i:e^s^i}i(d,n),d.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},d.prototype._update=function(t){for(var e,s=this._w,i=0|this._a,n=0|this._b,a=0|this._c,o=0|this._d,d=0|this._e,u=0;u<16;++u)s[u]=t.readInt32BE(4*u);for(;u<80;++u)s[u]=(e=s[u-3]^s[u-8]^s[u-14]^s[u-16])<<1|e>>>31;for(var m=0;m<80;++m){var c=~~(m/20),p=g(i)+l(c,n,a,o)+d+s[m]+r[c]|0;d=o,o=a,a=h(n),n=i,i=p}this._a=i+this._a|0,this._b=n+this._b|0,this._c=a+this._c|0,this._d=o+this._d|0,this._e=d+this._e|0},d.prototype._hash=function(){var t=a.allocUnsafe(20);return t.writeInt32BE(0|this._a,0),t.writeInt32BE(0|this._b,4),t.writeInt32BE(0|this._c,8),t.writeInt32BE(0|this._d,12),t.writeInt32BE(0|this._e,16),t},t.exports=d}}]);