(self.webpackChunkpeertube_client=self.webpackChunkpeertube_client||[]).push([[571],{62771:function(U,y,T){"use strict";var I=this&&this.__importDefault||function(E){return E&&E.__esModule?E:{default:E}};Object.defineProperty(y,"__esModule",{value:!0}),y.BandwidthApproximator=void 0;const P=I(T(57115)).default("p2pml:bandwidth-approximator"),v=2e3;class S{constructor(c,r){this.value=c,this.timeStamp=r}}y.BandwidthApproximator=class{constructor(){this.lastBytes=[],this.currentBytesSum=0,this.lastBandwidth=[],this.addBytes=(c,r)=>{for(P("Add %d bytes.",c),this.lastBytes.push(new S(c,r)),this.currentBytesSum+=c;r-this.lastBytes[0].timeStamp>v;)this.currentBytesSum-=this.lastBytes.shift().value;const l=Math.min(v,r);this.lastBandwidth.push(new S(this.currentBytesSum/l,r))},this.getBandwidth=c=>{for(;0!==this.lastBandwidth.length&&c-this.lastBandwidth[0].timeStamp>4e4;)this.lastBandwidth.shift();let r=0;for(const l of this.lastBandwidth)l.value>r&&(r=l.value);return P("Max bandwidth: %d.",r),r},this.getSmoothInterval=()=>v,this.getMeasureInterval=()=>4e4}}},67114:function(U,y,T){"use strict";var I=T(65963).default,_=this&&this.__importDefault||function(M){return M&&M.__esModule?M:{default:M}};Object.defineProperty(y,"__esModule",{value:!0}),y.HttpMediaManager=void 0;const P=_(T(57115)),v=T(82511);class R extends v.STEEmitter{}y.HttpMediaManager=class extends R{constructor(E){var c;super(),c=this,this.settings=E,this.xhrRequests=new Map,this.failedSegments=new Map,this.debug=P.default("p2pml:http-media-manager"),this.download=(r,l)=>{if(this.isDownloading(r))return;this.cleanTimedOutFailedSegments(),this.emit("segment-start-load",r);const t=this.settings.segmentUrlBuilder?this.settings.segmentUrlBuilder(r):r.url;this.debug("http segment download",t),r.requestUrl=t;const n=new XMLHttpRequest;if(n.open("GET",t,!0),n.responseType="arraybuffer",r.range)n.setRequestHeader("Range",r.range),l=void 0;else if(void 0!==l&&this.settings.httpUseRanges){let g=0;for(const w of l)g+=w.byteLength;n.setRequestHeader("Range",`bytes=${g}-`),this.debug("continue download from",g)}else l=void 0;this.setupXhrEvents(n,r,l),this.settings.xhrSetup&&this.settings.xhrSetup(n,t),this.xhrRequests.set(r.id,{xhr:n,segment:r}),n.send()},this.abort=r=>{const l=this.xhrRequests.get(r.id);l&&(l.xhr.abort(),this.xhrRequests.delete(r.id),this.debug("http segment abort",r.id))},this.isDownloading=r=>this.xhrRequests.has(r.id),this.isFailed=r=>{const l=this.failedSegments.get(r.id);return void 0!==l&&l>this.now()},this.getActiveDownloads=()=>this.xhrRequests,this.getActiveDownloadsCount=()=>this.xhrRequests.size,this.destroy=()=>{this.xhrRequests.forEach(r=>r.xhr.abort()),this.xhrRequests.clear()},this.setupXhrEvents=(r,l,t)=>{let n=0;r.addEventListener("progress",g=>{this.emit("bytes-downloaded",l,g.loaded-n),n=g.loaded,g.lengthComputable&&this.emit("segment-size",l,g.total)}),r.addEventListener("load",function(){var g=I(function*(w){if(r.status<200||r.status>=300)return void c.segmentFailure(l,w,r);let e=r.response;if(void 0!==t&&206===r.status){let D=0;for(const s of t)D+=s.byteLength;const h=new Uint8Array(D+e.byteLength);let f=0;for(const s of t)h.set(new Uint8Array(s),f),f+=s.byteLength;h.set(new Uint8Array(e),f),e=h.buffer}yield c.segmentDownloadFinished(l,e,r)});return function(w){return g.apply(this,arguments)}}()),r.addEventListener("error",g=>{this.segmentFailure(l,g,r)}),r.addEventListener("timeout",g=>{this.segmentFailure(l,g,r)})},this.segmentDownloadFinished=function(){var r=I(function*(l,t,n){if(l.responseUrl=null===n.responseURL?void 0:n.responseURL,c.settings.segmentValidator)try{yield c.settings.segmentValidator(Object.assign(Object.assign({},l),{data:t}),"http")}catch(g){return c.debug("segment validator failed",g),void c.segmentFailure(l,g,n)}c.xhrRequests.delete(l.id),c.emit("segment-loaded",l,t)});return function(l,t,n){return r.apply(this,arguments)}}(),this.segmentFailure=(r,l,t)=>{r.responseUrl=null===t.responseURL?void 0:t.responseURL,this.xhrRequests.delete(r.id),this.failedSegments.set(r.id,this.now()+this.settings.httpFailedSegmentTimeout),this.emit("segment-error",r,l)},this.cleanTimedOutFailedSegments=()=>{const r=this.now(),l=[];this.failedSegments.forEach((t,n)=>{t<r&&l.push(n)}),l.forEach(t=>this.failedSegments.delete(t))},this.now=()=>performance.now()}}},97057:function(U,y,T){"use strict";var I=T(65963).default,_=this&&this.__importDefault||function(g){return g&&g.__esModule?g:{default:g}};Object.defineProperty(y,"__esModule",{value:!0}),y.HybridLoader=void 0;const P=_(T(57115)),v=T(43674),R=_(T(71893)),S=T(4126),M=T(67114),E=T(58060),c=T(79190),r=T(62771),l=T(66616),t={cachedSegmentExpiration:3e5,cachedSegmentsCount:30,useP2P:!0,consumeOnly:!1,requiredSegmentsPriority:1,simultaneousHttpDownloads:2,httpDownloadProbability:.1,httpDownloadProbabilityInterval:1e3,httpDownloadProbabilitySkipIfNoPeers:!1,httpFailedSegmentTimeout:1e4,httpDownloadMaxPriority:20,httpDownloadInitialTimeout:0,httpDownloadInitialTimeoutPerSegment:4e3,httpUseRanges:!1,simultaneousP2PDownloads:3,p2pDownloadMaxPriority:20,p2pSegmentDownloadTimeout:6e4,webRtcMaxMessageSize:65535,trackerAnnounce:["wss://tracker.novage.com.ua","wss://tracker.openwebtorrent.com"],peerRequestsPerAnnounce:10,rtcConfig:R.default.config};class n extends v.EventEmitter{constructor(w={}){var e;super(),e=this,this.debug=P.default("p2pml:hybrid-loader"),this.debugSegments=P.default("p2pml:hybrid-loader-segments"),this.segmentsQueue=[],this.bandwidthApproximator=new r.BandwidthApproximator,this.httpDownloadInitialTimeoutTimestamp=-1/0,this.createHttpManager=()=>new M.HttpMediaManager(this.settings),this.createP2PManager=()=>new E.P2PMediaManager(this.segmentsStorage,this.settings),this.load=function(){var h=I(function*(f,s){void 0===e.httpRandomDownloadInterval&&(e.httpRandomDownloadInterval=setInterval(e.downloadRandomSegmentOverHttp,e.settings.httpDownloadProbabilityInterval),e.settings.httpDownloadInitialTimeout>0&&e.settings.httpDownloadInitialTimeoutPerSegment>0&&(e.debugSegments("enable initial HTTP download timeout",e.settings.httpDownloadInitialTimeout,"per segment",e.settings.httpDownloadInitialTimeoutPerSegment),e.httpDownloadInitialTimeoutTimestamp=e.now(),setTimeout(e.processInitialSegmentTimeout,e.settings.httpDownloadInitialTimeoutPerSegment+100))),f.length>0&&(e.masterSwarmId=f[0].masterSwarmId),void 0!==e.masterSwarmId&&e.p2pManager.setStreamSwarmId(s,e.masterSwarmId),e.debug("load segments");let i=!1;for(const u of e.segmentsQueue)f.find(b=>b.url===u.url)||(e.debug("remove segment",u.url),e.httpManager.isDownloading(u)?(i=!0,e.httpManager.abort(u)):e.p2pManager.abort(u),e.emit(S.Events.SegmentAbort,u));if(e.debug.enabled)for(const u of f)e.segmentsQueue.find(b=>b.url===u.url)||e.debug("add segment",u.url);if(e.segmentsQueue=f,void 0===e.masterSwarmId)return;let d=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);i=e.processSegmentsQueue(d)||i,(yield e.cleanSegmentsStorage())&&(d=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId),i=!0),i&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(d))});return function(f,s){return h.apply(this,arguments)}}(),this.getSegment=function(){var h=I(function*(f){return void 0===e.masterSwarmId?void 0:e.segmentsStorage.getSegment(f,e.masterSwarmId)});return function(f){return h.apply(this,arguments)}}(),this.getSettings=()=>this.settings,this.getDetails=()=>({peerId:this.p2pManager.getPeerId()}),this.getBandwidthEstimate=()=>this.bandwidthApproximator.getBandwidth(this.now()),this.destroy=I(function*(){void 0!==e.httpRandomDownloadInterval&&(clearInterval(e.httpRandomDownloadInterval),e.httpRandomDownloadInterval=void 0),e.httpDownloadInitialTimeoutTimestamp=-1/0,e.segmentsQueue=[],e.httpManager.destroy(),e.p2pManager.destroy(),e.masterSwarmId=void 0,yield e.segmentsStorage.destroy()}),this.processInitialSegmentTimeout=I(function*(){if(void 0!==e.httpRandomDownloadInterval){if(void 0!==e.masterSwarmId){const h=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(h)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(h))}e.httpDownloadInitialTimeoutTimestamp!==-1/0&&setTimeout(e.processInitialSegmentTimeout,e.settings.httpDownloadInitialTimeoutPerSegment)}}),this.processSegmentsQueue=h=>{if(this.debugSegments("process segments queue. priority",this.segmentsQueue.length>0?this.segmentsQueue[0].priority:0),void 0===this.masterSwarmId||0===this.segmentsQueue.length)return!1;let s,f=!1,i=!0;if(this.httpDownloadInitialTimeoutTimestamp!==-1/0){let d;for(const b of this.segmentsQueue)if(!h.has(b.id)){d=b.priority;break}const u=this.now()-this.httpDownloadInitialTimeoutTimestamp;i=u>=this.settings.httpDownloadInitialTimeout||void 0!==d&&u>this.settings.httpDownloadInitialTimeoutPerSegment&&d<=0,i&&(this.debugSegments("cancel initial HTTP download timeout - timed out"),this.httpDownloadInitialTimeoutTimestamp=-1/0)}for(let d=0;d<this.segmentsQueue.length;d++){const u=this.segmentsQueue[d];if(!h.has(u.id)&&!this.httpManager.isDownloading(u)){if(u.priority<=this.settings.requiredSegmentsPriority&&i&&!this.httpManager.isFailed(u)){if(this.httpManager.getActiveDownloadsCount()>=this.settings.simultaneousHttpDownloads)for(let b=this.segmentsQueue.length-1;b>d;b--){const p=this.segmentsQueue[b];if(this.httpManager.isDownloading(p)){this.debugSegments("cancel HTTP download",p.priority,p.url),this.httpManager.abort(p);break}}if(this.httpManager.getActiveDownloadsCount()<this.settings.simultaneousHttpDownloads){const b=this.p2pManager.abort(u);this.httpManager.download(u,b),this.debugSegments("HTTP download (priority)",u.priority,u.url),f=!0;continue}}if(!this.p2pManager.isDownloading(u)){if(u.priority<=this.settings.requiredSegmentsPriority){if(s=s||this.p2pManager.getOverallSegmentsMap(),s.get(u.id)!==c.MediaPeerSegmentStatus.Loaded)continue;if(this.p2pManager.getActiveDownloadsCount()>=this.settings.simultaneousP2PDownloads)for(let b=this.segmentsQueue.length-1;b>d;b--){const p=this.segmentsQueue[b];if(this.p2pManager.isDownloading(p)){this.debugSegments("cancel P2P download",p.priority,p.url),this.p2pManager.abort(p);break}}if(this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&this.p2pManager.download(u)){this.debugSegments("P2P download (priority)",u.priority,u.url);continue}continue}this.p2pManager.getActiveDownloadsCount()<this.settings.simultaneousP2PDownloads&&u.priority<=this.settings.p2pDownloadMaxPriority&&this.p2pManager.download(u)&&this.debugSegments("P2P download",u.priority,u.url)}}}return f},this.downloadRandomSegmentOverHttp=I(function*(){if(void 0===e.masterSwarmId||void 0===e.httpRandomDownloadInterval||e.httpDownloadInitialTimeoutTimestamp!==-1/0||e.httpManager.getActiveDownloadsCount()>=e.settings.simultaneousHttpDownloads||e.settings.httpDownloadProbabilitySkipIfNoPeers&&0===e.p2pManager.getPeers().size||e.settings.consumeOnly)return;const h=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId),f=e.p2pManager.getOverallSegmentsMap(),s=e.segmentsQueue.filter(d=>!e.p2pManager.isDownloading(d)&&!e.httpManager.isDownloading(d)&&!f.has(d.id)&&!e.httpManager.isFailed(d)&&d.priority<=e.settings.httpDownloadMaxPriority&&!h.has(d.id));if(0===s.length||Math.random()>e.settings.httpDownloadProbability*s.length)return;const i=s[Math.floor(Math.random()*s.length)];e.debugSegments("HTTP download (random)",i.priority,i.url),e.httpManager.download(i),e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(h))}),this.onSegmentStartLoad=(h,f)=>{this.emit(S.Events.SegmentStartLoad,h,f)},this.onPieceBytesDownloaded=(h,f,s,i)=>{this.bandwidthApproximator.addBytes(s,this.now()),this.emit(S.Events.PieceBytesDownloaded,h,f,s,i)},this.onPieceBytesUploaded=(h,f,s,i)=>{this.emit(S.Events.PieceBytesUploaded,h,f,s,i)},this.onSegmentLoaded=function(){var h=I(function*(f,s,i){if(e.debugSegments("segment loaded",f.id,f.url),void 0===e.masterSwarmId)return;f.data=s,f.downloadBandwidth=e.bandwidthApproximator.getBandwidth(e.now()),yield e.segmentsStorage.storeSegment(f),e.emit(S.Events.SegmentLoaded,f,i);const d=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(d),e.settings.consumeOnly||e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(d))});return function(f,s,i){return h.apply(this,arguments)}}(),this.onSegmentError=function(){var h=I(function*(f,s,i){if(e.debugSegments("segment error",f.id,f.url,i,s),e.emit(S.Events.SegmentError,f,s,i),void 0!==e.masterSwarmId){const d=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(d)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(d))}});return function(f,s,i){return h.apply(this,arguments)}}(),this.onSegmentSize=function(){var h=I(function*(f,s){e.debugSegments("segment size",f.id,s),e.emit(S.Events.SegmentSize,f,s)});return function(f,s){return h.apply(this,arguments)}}(),this.getStreamSwarmId=h=>void 0===h.streamId?h.masterSwarmId:`${h.masterSwarmId}+${h.streamId}`,this.createSegmentsMap=h=>{const f={},s=(i,d)=>{const u=this.getStreamSwarmId(i),b=i.sequence;let p=f[u];void 0===p&&(p=["",[]],f[u]=p);const a=p[1];p[0]+=0===a.length?b:`|${b}`,a.push(d)};for(const i of h.values())s(i.segment,c.MediaPeerSegmentStatus.Loaded);for(const i of this.httpManager.getActiveDownloads().values())s(i.segment,c.MediaPeerSegmentStatus.LoadingByHttp);return f},this.onPeerConnect=function(){var h=I(function*(f){e.emit(S.Events.PeerConnect,f),!e.settings.consumeOnly&&void 0!==e.masterSwarmId&&e.p2pManager.sendSegmentsMap(f.id,e.createSegmentsMap(yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId)))});return function(f){return h.apply(this,arguments)}}(),this.onPeerClose=h=>{this.emit(S.Events.PeerClose,h)},this.onTrackerUpdate=function(){var h=I(function*(f){if(e.httpDownloadInitialTimeoutTimestamp!==-1/0&&void 0!==f.incomplete&&f.incomplete<=1&&(e.debugSegments("cancel initial HTTP download timeout - no peers"),e.httpDownloadInitialTimeoutTimestamp=-1/0,void 0!==e.masterSwarmId)){const s=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(s)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(s))}});return function(f){return h.apply(this,arguments)}}(),this.cleanSegmentsStorage=I(function*(){return void 0!==e.masterSwarmId&&e.segmentsStorage.clean(e.masterSwarmId,h=>void 0!==e.segmentsQueue.find(f=>f.id===h))}),this.now=()=>performance.now(),this.settings=Object.assign(Object.assign({},t),w);const{bufferedSegmentsCount:D}=w;"number"==typeof D&&(void 0===w.p2pDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=D),void 0===w.httpDownloadMaxPriority&&(this.settings.p2pDownloadMaxPriority=D)),this.segmentsStorage=void 0===this.settings.segmentsStorage?new l.SegmentsMemoryStorage(this.settings):this.settings.segmentsStorage,this.debug("loader settings",this.settings),this.httpManager=this.createHttpManager(),this.httpManager.on("segment-start-load",h=>this.onSegmentStartLoad("http",h)),this.httpManager.on("segment-loaded",this.onSegmentLoaded),this.httpManager.on("segment-error",this.onSegmentError),this.httpManager.on("segment-size",this.onSegmentSize),this.httpManager.on("bytes-downloaded",(h,f)=>{this.onPieceBytesDownloaded("http",h,f)}),this.p2pManager=this.createP2PManager(),this.p2pManager.on("segment-start-load",h=>this.onSegmentStartLoad("p2p",h)),this.p2pManager.on("segment-loaded",this.onSegmentLoaded),this.p2pManager.on("segment-error",this.onSegmentError),this.p2pManager.on("segment-size",this.onSegmentSize),this.p2pManager.on("peer-data-updated",I(function*(){if(void 0===e.masterSwarmId)return;const h=yield e.segmentsStorage.getSegmentsMap(e.masterSwarmId);e.processSegmentsQueue(h)&&!e.settings.consumeOnly&&e.p2pManager.sendSegmentsMapToAll(e.createSegmentsMap(h))})),this.p2pManager.on("bytes-downloaded",(h,f,s)=>this.onPieceBytesDownloaded("p2p",h,f,s)),this.p2pManager.on("bytes-uploaded",(h,f,s)=>this.onPieceBytesUploaded("p2p",h,f,s)),this.p2pManager.on("peer-connected",this.onPeerConnect),this.p2pManager.on("peer-closed",this.onPeerClose),this.p2pManager.on("tracker-update",this.onTrackerUpdate)}}y.HybridLoader=n,n.isSupported=()=>void 0!==window.RTCPeerConnection.prototype.createDataChannel},12546:function(U,y,T){"use strict";var I=this&&this.__createBinding||(Object.create?function(P,v,R,S){void 0===S&&(S=R),Object.defineProperty(P,S,{enumerable:!0,get:function(){return v[R]}})}:function(P,v,R,S){void 0===S&&(S=R),P[S]=v[R]}),_=this&&this.__exportStar||function(P,v){for(var R in P)"default"!==R&&!Object.prototype.hasOwnProperty.call(v,R)&&I(v,P,R)};Object.defineProperty(y,"__esModule",{value:!0}),y.version=void 0,y.version="0.6.2",_(T(4126),y),_(T(97057),y)},4126:(U,y)=>{"use strict";var I;Object.defineProperty(y,"__esModule",{value:!0}),y.Events=void 0,(I=y.Events||(y.Events={})).SegmentLoaded="segment_loaded",I.SegmentError="segment_error",I.SegmentSize="segment_size",I.SegmentAbort="segment_abort",I.SegmentStartLoad="segment_start_load",I.PeerConnect="peer_connect",I.PeerClose="peer_close",I.PieceBytesDownloaded="piece_bytes_downloaded",I.PieceBytesUploaded="piece_bytes_uploaded"},79190:function(U,y,T){"use strict";var I=this&&this.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(y,"__esModule",{value:!0}),y.MediaPeer=y.MediaPeerSegmentStatus=void 0;const _=I(T(57115)),P=T(16853),v=T(82511);var S,c,R=(()=>{return(c=R||(R={}))[c.SegmentData=0]="SegmentData",c[c.SegmentAbsent=1]="SegmentAbsent",c[c.SegmentsMap=2]="SegmentsMap",c[c.SegmentRequest=3]="SegmentRequest",c[c.CancelSegmentRequest=4]="CancelSegmentRequest",R;var c})();(c=S=y.MediaPeerSegmentStatus||(y.MediaPeerSegmentStatus={}))[c.Loaded=0]="Loaded",c[c.LoadingByHttp=1]="LoadingByHttp";class M{constructor(r,l){this.id=r,this.size=l,this.bytesDownloaded=0,this.pieces=[]}}y.MediaPeer=class extends v.STEEmitter{constructor(r,l){super(),this.peer=r,this.settings=l,this.remoteAddress="",this.downloadingSegmentId=null,this.downloadingSegment=null,this.segmentsMap=new Map,this.debug=_.default("p2pml:media-peer"),this.timer=null,this.onPeerConnect=()=>{this.debug("peer connect",this.id,this),this.remoteAddress=this.peer.remoteAddress,this.emit("connect",this)},this.onPeerClose=()=>{this.debug("peer close",this.id,this),this.terminateSegmentRequest(),this.emit("close",this)},this.onPeerError=t=>{this.debug("peer error",this.id,t,this)},this.receiveSegmentPiece=t=>{if(!this.downloadingSegment)return void this.debug("peer segment not requested",this.id,this);this.downloadingSegment.bytesDownloaded+=t.byteLength,this.downloadingSegment.pieces.push(t);const n=this.downloadingSegment.id;if(this.emit("bytes-downloaded",this,n,t.byteLength),this.downloadingSegment.bytesDownloaded===this.downloadingSegment.size){const g=new Uint8Array(this.downloadingSegment.size);let w=0;for(const e of this.downloadingSegment.pieces)g.set(new Uint8Array(e),w),w+=e.byteLength;this.debug("peer segment download done",this.id,n,this),this.terminateSegmentRequest(),this.emit("segment-loaded",this,n,g.buffer)}else this.downloadingSegment.bytesDownloaded>this.downloadingSegment.size&&(this.debug("peer segment download bytes mismatch",this.id,n,this),this.terminateSegmentRequest(),this.emit("segment-error",this,n,"Too many bytes received for segment"))},this.getJsonCommand=t=>{const n=new Uint8Array(t);if(123===n[0]&&34===n[1]&&125===n[t.byteLength-1])try{return JSON.parse((new TextDecoder).decode(t))}catch(g){return null}return null},this.onPeerData=t=>{const n=this.getJsonCommand(t);if(null!==n){if(this.downloadingSegment){this.debug("peer segment download is interrupted by a command",this.id,this);const g=this.downloadingSegment.id;return this.terminateSegmentRequest(),void this.emit("segment-error",this,g,"Segment download is interrupted by a command")}switch(this.debug("peer receive command",this.id,n,this),n.c){case R.SegmentsMap:this.segmentsMap=this.createSegmentsMap(n.m),this.emit("data-updated");break;case R.SegmentRequest:this.emit("segment-request",this,n.i);break;case R.SegmentData:this.downloadingSegmentId&&this.downloadingSegmentId===n.i&&"number"==typeof n.s&&n.s>=0&&(this.downloadingSegment=new M(n.i,n.s),this.emit("segment-start-load",this.downloadingSegment.id),this.emit("segment-size",this.downloadingSegment.id,this.downloadingSegment.size),this.cancelResponseTimeoutTimer());break;case R.SegmentAbsent:this.downloadingSegmentId&&this.downloadingSegmentId===n.i&&(this.terminateSegmentRequest(),this.segmentsMap.delete(n.i),this.emit("segment-absent",this,n.i))}}else this.receiveSegmentPiece(t)},this.createSegmentsMap=t=>{if(!(t instanceof Object))return new Map;const n=new Map;for(const g of Object.keys(t)){const w=t[g];if(!(w instanceof Array&&2===w.length&&"string"==typeof w[0]&&w[1]instanceof Array))return new Map;const e=w[0].split("|"),D=w[1];if(e.length!==D.length)return new Map;for(let h=0;h<e.length;h++){const f=D[h];if("number"!=typeof f||void 0===S[f])return new Map;n.set(`${g}+${e[h]}`,f)}}return n},this.sendCommand=t=>{this.debug("peer send command",this.id,t,this),this.peer.write(JSON.stringify(t))},this.destroy=()=>{this.debug("peer destroy",this.id,this),this.terminateSegmentRequest(),this.peer.destroy()},this.getDownloadingSegmentId=()=>this.downloadingSegmentId,this.getSegmentsMap=()=>this.segmentsMap,this.sendSegmentsMap=t=>{this.sendCommand({c:R.SegmentsMap,m:t})},this.sendSegmentData=(t,n)=>{this.sendCommand({c:R.SegmentData,i:t,s:n.byteLength});let g=n.byteLength;for(;g>0;){const w=g>=this.settings.webRtcMaxMessageSize?this.settings.webRtcMaxMessageSize:g,e=P.Buffer.from(n,n.byteLength-g,w);this.peer.write(e),g-=w}this.emit("bytes-uploaded",this,t,n.byteLength)},this.sendSegmentAbsent=t=>{this.sendCommand({c:R.SegmentAbsent,i:t})},this.requestSegment=t=>{if(this.downloadingSegmentId)throw new Error("A segment is already downloading: "+this.downloadingSegmentId);this.sendCommand({c:R.SegmentRequest,i:t}),this.downloadingSegmentId=t,this.runResponseTimeoutTimer()},this.cancelSegmentRequest=()=>{let t;if(this.downloadingSegmentId){const n=this.downloadingSegmentId;t=this.downloadingSegment?this.downloadingSegment.pieces:void 0,this.terminateSegmentRequest(),this.sendCommand({c:R.CancelSegmentRequest,i:n})}return t},this.runResponseTimeoutTimer=()=>{this.timer=setTimeout(()=>{if(this.timer=null,!this.downloadingSegmentId)return;const t=this.downloadingSegmentId;this.cancelSegmentRequest(),this.emit("segment-timeout",this,t)},this.settings.p2pSegmentDownloadTimeout)},this.cancelResponseTimeoutTimer=()=>{this.timer&&(clearTimeout(this.timer),this.timer=null)},this.terminateSegmentRequest=()=>{this.downloadingSegmentId=null,this.downloadingSegment=null,this.cancelResponseTimeoutTimer()},this.peer.on("connect",this.onPeerConnect),this.peer.on("close",this.onPeerClose),this.peer.on("error",this.onPeerError),this.peer.on("data",this.onPeerData),this.id=r.id}}},58060:function(U,y,T){"use strict";var I=T(65963).default,_=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(y,"__esModule",{value:!0}),y.P2PMediaManager=void 0;const P=_(T(57115)),v=_(T(26336)),R=T(16853),S=_(T(24274)),M=T(82511),E=T(79190),t=`-WW${T(12546).version.replace(/\d*./g,e=>("0"+parseInt(e,10)%100).slice(-2)).slice(0,4)}-`;class n{constructor(D,h){this.peerId=D,this.segment=h}}y.P2PMediaManager=class extends M.STEEmitter{constructor(D,h){var f;super(),f=this,this.segmentsStorage=D,this.settings=h,this.trackerClient=null,this.peers=new Map,this.peerCandidates=new Map,this.peerSegmentRequests=new Map,this.streamSwarmId=null,this.debug=P.default("p2pml:p2p-media-manager"),this.pendingTrackerClient=null,this.getPeers=()=>this.peers,this.getPeerId=()=>R.Buffer.from(this.peerId).toString("hex"),this.setStreamSwarmId=(s,i)=>{if(this.streamSwarmId===s)return;this.destroy(!0),this.streamSwarmId=s,this.masterSwarmId=i,this.debug("stream swarm ID",this.streamSwarmId),this.pendingTrackerClient={isDestroyed:!1};const d=this.pendingTrackerClient,u=(new S.default).update(`2${this.streamSwarmId}`).digest();d.isDestroyed?null!==this.trackerClient&&(this.trackerClient.destroy(),this.trackerClient=null):(this.pendingTrackerClient=null,this.createClient(u))},this.createClient=s=>{if(!this.settings.useP2P)return;const i={infoHash:R.Buffer.from(s,0,20),peerId:R.Buffer.from(this.peerId,0,20),announce:this.settings.trackerAnnounce,rtcConfig:this.settings.rtcConfig,port:6881,getAnnounceOpts:()=>({numwant:this.settings.peerRequestsPerAnnounce})};let d=this.trackerClient;this.trackerClient=new v.default(i),this.trackerClient.on("error",this.onTrackerError),this.trackerClient.on("warning",this.onTrackerWarning),this.trackerClient.on("update",this.onTrackerUpdate),this.trackerClient.on("peer",this.onTrackerPeer),this.trackerClient.start(),null!==d&&(d.destroy(),d=null)},this.onTrackerError=s=>{this.debug("tracker error",s)},this.onTrackerWarning=s=>{this.debug("tracker warning",s)},this.onTrackerUpdate=s=>{this.debug("tracker update",s),this.emit("tracker-update",s)},this.onTrackerPeer=s=>{if(this.debug("tracker peer",s.id,s),this.peers.has(s.id))return this.debug("tracker peer already connected",s.id,s),void s.destroy();const i=new E.MediaPeer(s,this.settings);i.on("connect",this.onPeerConnect),i.on("close",this.onPeerClose),i.on("data-updated",this.onPeerDataUpdated),i.on("segment-request",this.onSegmentRequest),i.on("segment-loaded",this.onSegmentLoaded),i.on("segment-absent",this.onSegmentAbsent),i.on("segment-error",this.onSegmentError),i.on("segment-size",this.onSegmentSize),i.on("segment-start-load",this.onSegmentStartLoad),i.on("segment-timeout",this.onSegmentTimeout),i.on("bytes-downloaded",this.onPieceBytesDownloaded),i.on("bytes-uploaded",this.onPieceBytesUploaded);let d=this.peerCandidates.get(i.id);d||(d=[],this.peerCandidates.set(i.id,d)),d.push(i)},this.download=s=>{if(this.isDownloading(s))return!1;const i=[];for(const u of this.peers.values())null===u.getDownloadingSegmentId()&&u.getSegmentsMap().get(s.id)===E.MediaPeerSegmentStatus.Loaded&&i.push(u);if(0===i.length)return!1;const d=i[Math.floor(Math.random()*i.length)];return d.requestSegment(s.id),this.peerSegmentRequests.set(s.id,new n(d.id,s)),!0},this.abort=s=>{let i;const d=this.peerSegmentRequests.get(s.id);if(d){const u=this.peers.get(d.peerId);u&&(i=u.cancelSegmentRequest()),this.peerSegmentRequests.delete(s.id)}return i},this.isDownloading=s=>this.peerSegmentRequests.has(s.id),this.getActiveDownloadsCount=()=>this.peerSegmentRequests.size,this.destroy=(s=!1)=>{this.streamSwarmId=null,this.trackerClient&&(this.trackerClient.stop(),s?(this.trackerClient.removeAllListeners("error"),this.trackerClient.removeAllListeners("warning"),this.trackerClient.removeAllListeners("update"),this.trackerClient.removeAllListeners("peer")):(this.trackerClient.destroy(),this.trackerClient=null)),this.pendingTrackerClient&&(this.pendingTrackerClient.isDestroyed=!0,this.pendingTrackerClient=null),this.peers.forEach(i=>i.destroy()),this.peers.clear(),this.peerSegmentRequests.clear();for(const i of this.peerCandidates.values())for(const d of i)d.destroy();this.peerCandidates.clear()},this.sendSegmentsMapToAll=s=>{this.peers.forEach(i=>i.sendSegmentsMap(s))},this.sendSegmentsMap=(s,i)=>{const d=this.peers.get(s);d&&d.sendSegmentsMap(i)},this.getOverallSegmentsMap=()=>{const s=new Map;for(const i of this.peers.values())for(const[d,u]of i.getSegmentsMap())u===E.MediaPeerSegmentStatus.Loaded?s.set(d,E.MediaPeerSegmentStatus.Loaded):s.get(d)||s.set(d,E.MediaPeerSegmentStatus.LoadingByHttp);return s},this.onPieceBytesDownloaded=(s,i,d)=>{const u=this.peerSegmentRequests.get(i);u&&this.emit("bytes-downloaded",u.segment,d,s.id)},this.onPieceBytesUploaded=(s,i,d)=>{const u=this.peerSegmentRequests.get(i);u&&this.emit("bytes-uploaded",u.segment,d,s.id)},this.onPeerConnect=s=>{if(this.peers.get(s.id))return this.debug("tracker peer already connected (in peer connect)",s.id,s),void s.destroy();this.peers.set(s.id,s);const d=this.peerCandidates.get(s.id);if(d){for(const u of d)u!==s&&u.destroy();this.peerCandidates.delete(s.id)}this.emit("peer-connected",{id:s.id,remoteAddress:s.remoteAddress})},this.onPeerClose=s=>{if(this.peers.get(s.id)!==s){const i=this.peerCandidates.get(s.id);if(!i)return;const d=i.indexOf(s);return-1!==d&&i.splice(d,1),void(0===i.length&&this.peerCandidates.delete(s.id))}for(const[i,d]of this.peerSegmentRequests)d.peerId===s.id&&this.peerSegmentRequests.delete(i);this.peers.delete(s.id),this.emit("peer-data-updated"),this.emit("peer-closed",s.id)},this.onPeerDataUpdated=()=>{this.emit("peer-data-updated")},this.onSegmentRequest=function(){var s=I(function*(i,d){if(void 0===f.masterSwarmId)return;const u=yield f.segmentsStorage.getSegment(d,f.masterSwarmId);u&&u.data?i.sendSegmentData(d,u.data):i.sendSegmentAbsent(d)});return function(i,d){return s.apply(this,arguments)}}(),this.onSegmentLoaded=function(){var s=I(function*(i,d,u){const b=f.peerSegmentRequests.get(d);if(!b)return;const p=b.segment;if(f.settings.segmentValidator)try{yield f.settings.segmentValidator(Object.assign(Object.assign({},p),{data:u}),"p2p",i.id)}catch(a){return f.debug("segment validator failed",a),f.peerSegmentRequests.delete(d),f.emit("segment-error",p,a,i.id),void f.onPeerClose(i)}f.peerSegmentRequests.delete(d),f.emit("segment-loaded",p,u,i.id)});return function(i,d,u){return s.apply(this,arguments)}}(),this.onSegmentAbsent=(s,i)=>{this.peerSegmentRequests.delete(i),this.emit("peer-data-updated")},this.onSegmentError=(s,i,d)=>{const u=this.peerSegmentRequests.get(i);u&&(this.peerSegmentRequests.delete(i),this.emit("segment-error",u.segment,d,s.id))},this.onSegmentSize=(s,i)=>{const d=this.peerSegmentRequests.get(s);d&&this.emit("segment-size",d.segment,i)},this.onSegmentStartLoad=(s,i)=>{const d=this.peerSegmentRequests.get(s);d&&this.emit("segment-start-load",d.segment,i)},this.onSegmentTimeout=(s,i)=>{const d=this.peerSegmentRequests.get(i);d&&(this.peerSegmentRequests.delete(i),s.destroy(),this.peers.delete(d.peerId)&&this.emit("peer-data-updated"))},this.peerId=h.useP2P?function(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let h=t;for(let f=0;f<20-t.length;f++)h+=e.charAt(Math.floor(Math.random()*e.length));return(new TextEncoder).encode(h).buffer}():new ArrayBuffer(0),this.debug.enabled&&this.debug("peer ID",this.getPeerId(),(new TextDecoder).decode(this.peerId))}}},66616:(U,y,T)=>{"use strict";var I=T(65963).default;Object.defineProperty(y,"__esModule",{value:!0}),y.SegmentsMemoryStorage=void 0,y.SegmentsMemoryStorage=class{constructor(v){var R=this;this.settings=v,this.cache=new Map,this.storeSegment=function(){var S=I(function*(M){R.cache.set(M.id,{segment:M,lastAccessed:performance.now()})});return function(M){return S.apply(this,arguments)}}(),this.getSegmentsMap=I(function*(){return R.cache}),this.getSegment=function(){var S=I(function*(M){const E=R.cache.get(M);if(void 0!==E)return E.lastAccessed=performance.now(),E.segment});return function(M){return S.apply(this,arguments)}}(),this.hasSegment=function(){var S=I(function*(M){return R.cache.has(M)});return function(M){return S.apply(this,arguments)}}(),this.clean=function(){var S=I(function*(M,E){const c=[],r=[],l=performance.now();for(const n of R.cache.values())l-n.lastAccessed>R.settings.cachedSegmentExpiration?c.push(n.segment.id):r.push(n);let t=r.length-R.settings.cachedSegmentsCount;if(t>0){r.sort((n,g)=>n.lastAccessed-g.lastAccessed);for(const n of r)if((void 0===E||!E(n.segment.id))&&(c.push(n.segment.id),t--,0===t))break}return c.forEach(n=>R.cache.delete(n)),c.length>0});return function(M,E){return S.apply(this,arguments)}}(),this.destroy=I(function*(){R.cache.clear()})}}},82511:(U,y,T)=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0}),y.STEEmitter=void 0;const I=T(43674);y.STEEmitter=class extends I.EventEmitter{constructor(){super(...arguments),this.on=(v,R)=>super.on(v,R),this.emit=(v,...R)=>super.emit(v,...R)}}},53013:(U,y)=>{"use strict";Object.defineProperty(y,"__esModule",{value:!0}),y.byteRangeToString=y.compareByteRanges=y.getByteRange=void 0,y.getByteRange=function(P){return P.rangeEnd&&void 0!==P.rangeStart?{offset:P.rangeStart,length:P.rangeEnd-P.rangeStart}:void 0},y.compareByteRanges=function(P,v){return void 0===P?void 0===v:void 0!==v&&P.length===v.length&&P.offset===v.offset},y.byteRangeToString=function(P){if(void 0!==P)return`bytes=${P.offset}-${P.offset+P.length-1}`}},37818:(U,y,T)=>{"use strict";var I=T(65963).default;Object.defineProperty(y,"__esModule",{value:!0}),y.Engine=void 0;const _=T(43674),P=T(12546),v=T(80907),R=T(55604);y.Engine=class extends _.EventEmitter{constructor(E={}){super(),this.loader=new P.HybridLoader(E.loader),this.segmentManager=new v.SegmentManager(this.loader,E.segments),Object.keys(P.Events).map(c=>P.Events[c]).forEach(c=>this.loader.on(c,(...r)=>this.emit(c,...r)))}static isSupported(){return P.HybridLoader.isSupported()}createLoaderClass(){var E;const c=this;return(E=class{constructor(){var r=this;this.load=function(){var l=I(function*(t,n,g){r.context=t,r.callbacks=g,yield r.impl.load(t,n,g)});return function(t,n,g){return l.apply(this,arguments)}}(),this.abort=()=>{this.context&&this.impl.abort(this.context,this.callbacks)},this.destroy=()=>{this.context&&this.impl.abort(this.context)},this.getResponseHeader=()=>{},this.impl=new R.HlsJsLoader(c.segmentManager),this.stats=this.impl.stats}}).getEngine=()=>c,E}destroy(){var E=this;return I(function*(){yield E.segmentManager.destroy()})()}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}setPlayingSegment(E,c,r,l){this.segmentManager.setPlayingSegment(E,c,r,l)}setPlayingSegmentByCurrentTime(E){this.segmentManager.setPlayingSegmentByCurrentTime(E)}}},55604:(U,y,T)=>{"use strict";var I=T(65963).default;Object.defineProperty(y,"__esModule",{value:!0}),y.HlsJsLoader=void 0;const _=T(12546),P=T(53013);class v{constructor(S){this.isLoaded=!1,this.stats={loaded:0,total:0,aborted:!1,retry:0,chunkCount:0,bwEstimate:0,loading:{start:0,end:0,first:0},parsing:{start:0,end:0},buffering:{start:0,end:0,first:0}},this.segmentManager=S}load(S,M,E){var c=this;return I(function*(){if(v.updateStatsToStartLoading(c.stats),S.type)try{const r=yield c.segmentManager.loadPlaylist(S.url);c.isLoaded=!0,c.successPlaylist(r,S,E)}catch(r){c.error(r,S,E)}else if(S.frag){const{loader:r}=c.segmentManager,l=P.getByteRange(S),t=D=>D.url===S.url&&D.range===P.byteRangeToString(l);let n=setInterval(()=>{v.updateStatsToStartLoading(c.stats)},200);const g=(D,h)=>{!t(D)||(c.stats.total=h)};r.on(_.Events.SegmentSize,g);const w=(D,h,f)=>{!t(h)||(c.stats.loaded+=f)},e=(D,h)=>{!n||"http"!==D||!t(h)||(clearInterval(n),n=void 0,v.updateStatsToStartLoading(c.stats),r.on(_.Events.PieceBytesDownloaded,w))};r.on(_.Events.SegmentStartLoad,e);try{const D=yield c.segmentManager.loadSegment(S.url,l),{content:h}=D;h&&(c.isLoaded=!0,setTimeout(()=>c.successSegment(h,S,E),0))}catch(D){setTimeout(()=>c.error(D,S,E),0)}finally{clearInterval(n),r.off(_.Events.SegmentStartLoad,e),r.off(_.Events.SegmentSize,g),r.off(_.Events.PieceBytesDownloaded,w)}}else console.warn("Unknown load request",S)})()}abort(S,M){if(this.isLoaded)return;this.segmentManager.abortSegment(S.url,P.getByteRange(S)),this.stats.aborted=!0;const E=null==M?void 0:M.onAbort;E&&E(this.stats,S,void 0)}successPlaylist(S,M,E){const c=performance.now();this.stats.loading.end=c,this.stats.loaded=S.response.length,this.stats.total=S.response.length,E.onSuccess({url:S.responseURL,data:S.response},this.stats,M,void 0)}successSegment(S,M,E){const c=performance.now();this.stats.loading.end=c,this.stats.loaded=S.byteLength,this.stats.total=S.byteLength,E.onProgress&&E.onProgress(this.stats,M,S,void 0),E.onSuccess({url:M.url,data:S},this.stats,M,void 0)}error(S,M,E){E.onError(S,M,void 0)}static updateStatsToStartLoading(S){const M=performance.now();S.loading.start=M,S.loading.first=M}}y.HlsJsLoader=v},58571:function(U,y,T){"use strict";var I=T(65963).default,_=this&&this.__createBinding||(Object.create?function(t,n,g,w){void 0===w&&(w=g),Object.defineProperty(t,w,{enumerable:!0,get:function(){return n[g]}})}:function(t,n,g,w){void 0===w&&(w=g),t[w]=n[g]}),P=this&&this.__exportStar||function(t,n){for(var g in t)"default"!==g&&!Object.prototype.hasOwnProperty.call(n,g)&&_(n,t,g)};function v(t){t&&t.config&&t.config.loader&&"function"==typeof t.config.loader.getEngine&&l(t,t.config.loader.getEngine())}function l(t,n){t.on("hlsFragChanged",(g,w)=>{const e=w.frag;n.setPlayingSegment(e.url,2!==e.byteRange.length?void 0:{offset:e.byteRange[0],length:e.byteRange[1]-e.byteRange[0]},e.start,e.duration)}),t.on("hlsDestroying",I(function*(){yield n.destroy()})),t.on("hlsError",(g,w)=>{if("bufferStalledError"===w.details){const e=void 0===t.media?t.el_:t.media;e&&n.setPlayingSegmentByCurrentTime(e.currentTime)}})}Object.defineProperty(y,"__esModule",{value:!0}),y.initJwPlayer=y.initMediaElementJsPlayer=y.initVideoJsHlsJsPlugin=y.initVideoJsContribHlsJsPlayer=y.initFlowplayerHlsJsPlayer=y.initClapprPlayer=y.initHlsJsPlayer=y.version=void 0,y.version="0.6.2",P(T(37818),y),P(T(80907),y),y.initHlsJsPlayer=v,y.initClapprPlayer=function(t){t.on("play",()=>{const n=t.core.getCurrentPlayback();n._hls&&!n._hls._p2pm_linitialized&&(n._hls._p2pm_linitialized=!0,v(t.core.getCurrentPlayback()._hls))})},y.initFlowplayerHlsJsPlayer=function(t){t.on("ready",()=>{var n;return v(null!==(n=t.engine.hlsjs)&&void 0!==n?n:t.engine.hls)})},y.initVideoJsContribHlsJsPlayer=function(t){t.ready(()=>{const n=t.tech_.options_;n&&n.hlsjsConfig&&n.hlsjsConfig.loader&&"function"==typeof n.hlsjsConfig.loader.getEngine&&l(t.tech_,n.hlsjsConfig.loader.getEngine())})},y.initVideoJsHlsJsPlugin=function(){null==videojs||null==videojs.Html5Hlsjs||videojs.Html5Hlsjs.addHook("beforeinitialize",(t,n)=>{n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&l(n,n.config.loader.getEngine())})},y.initMediaElementJsPlayer=function(t){t.addEventListener("hlsFragChanged",n=>{const g=t.hlsPlayer;if(g&&g.config&&g.config.loader&&"function"==typeof g.config.loader.getEngine){const w=g.config.loader.getEngine();if(n.data&&n.data.length>1){const e=n.data[1].frag;w.setPlayingSegment(e.url,2!==e.byteRange.length?void 0:{offset:e.byteRange[0],length:e.byteRange[1]-e.byteRange[0]},e.start,e.duration)}}}),t.addEventListener("hlsDestroying",I(function*(){const n=t.hlsPlayer;n&&n.config&&n.config.loader&&"function"==typeof n.config.loader.getEngine&&(yield n.config.loader.getEngine().destroy())})),t.addEventListener("hlsError",n=>{const g=t.hlsPlayer;g&&g.config&&g.config.loader&&"function"==typeof g.config.loader.getEngine&&void 0!==n.data&&"bufferStalledError"===n.data.details&&g.config.loader.getEngine().setPlayingSegmentByCurrentTime(g.media.currentTime)})},y.initJwPlayer=function(t,n){const g=setInterval(()=>{t.hls&&t.hls.config&&(clearInterval(g),Object.assign(t.hls.config,n),v(t.hls))},200)}},80907:(U,y,T)=>{"use strict";var I=T(65963).default;Object.defineProperty(y,"__esModule",{value:!0}),y.SegmentManager=void 0;const _=T(12546),P=T(51961),v=T(53013),R={forwardSegmentCount:20,swarmId:void 0,assetsStorage:void 0};y.SegmentManager=class{constructor(r,l={}){this.masterPlaylist=null,this.variantPlaylists=new Map,this.segmentRequest=null,this.playQueue=[],this.onSegmentLoaded=t=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&v.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onSuccess(t.data.slice(0),t.downloadBandwidth),this.segmentRequest=null)},this.onSegmentError=(t,n)=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&v.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onError(n),this.segmentRequest=null)},this.onSegmentAbort=t=>{this.segmentRequest&&this.segmentRequest.segmentUrl===t.url&&v.byteRangeToString(this.segmentRequest.segmentByteRange)===t.range&&(this.segmentRequest.onError("Loading aborted: internal abort"),this.segmentRequest=null)},this.settings=Object.assign(Object.assign({},R),l),this.loader=r,this.loader.on(_.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(_.Events.SegmentError,this.onSegmentError),this.loader.on(_.Events.SegmentAbort,this.onSegmentAbort)}getSettings(){return this.settings}processPlaylist(r,l,t){const n=new P.Parser;n.push(l),n.end();const g=new M(r,t,n.manifest);if(g.manifest.playlists){this.masterPlaylist=g;for(const[w,e]of this.variantPlaylists){const{streamSwarmId:D,found:h,index:f}=this.getStreamSwarmId(e.requestUrl);h?(e.streamSwarmId=D,e.streamId="V"+f.toString()):this.variantPlaylists.delete(w)}}else{const{streamSwarmId:w,found:e,index:D}=this.getStreamSwarmId(r);(e||null===this.masterPlaylist)&&(g.streamSwarmId=w,g.streamId=null===this.masterPlaylist?void 0:"V"+D.toString(),this.variantPlaylists.set(r,g),this.updateSegments())}}loadPlaylist(r){var l=this;return I(function*(){const t=l.settings.assetsStorage;let n;if(void 0!==t){let g;g=l.getMasterSwarmId(),void 0===g&&(g=r.split("?")[0]);const w=yield t.getAsset(r,void 0,g);void 0!==w?n={responseURL:w.responseUri,response:w.data}:(n=yield l.loadContent(r,"text"),t.storeAsset({masterManifestUri:null!==l.masterPlaylist?l.masterPlaylist.requestUrl:r,masterSwarmId:g,requestUri:r,responseUri:n.responseURL,data:n.response}))}else n=yield l.loadContent(r,"text");return l.processPlaylist(r,n.response,n.responseURL),n})()}loadSegment(r,l){var t=this;return I(function*(){var n;const g=t.getSegmentLocation(r,l),w=v.byteRangeToString(l);if(!g){let h;const f=t.settings.assetsStorage;if(void 0!==f){let i,s=null===(n=t.masterPlaylist)||void 0===n?void 0:n.requestUrl;if(i=t.getMasterSwarmId(),void 0===i&&1===t.variantPlaylists.size){const d=t.variantPlaylists.values().next();d.done||(i=d.value.requestUrl.split("?")[0])}if(void 0===s&&1===t.variantPlaylists.size){const d=t.variantPlaylists.values().next();d.done||(s=d.value.requestUrl)}if(void 0!==i&&void 0!==s){const d=yield f.getAsset(r,w,i);if(void 0!==d)h=d.data;else{const u=yield t.loadContent(r,"arraybuffer",w);h=u.response,f.storeAsset({masterManifestUri:s,masterSwarmId:i,requestUri:r,requestRange:w,responseUri:u.responseURL,data:h})}}}return void 0===h&&(h=(yield t.loadContent(r,"arraybuffer",w)).response),{content:h,downloadBandwidth:0}}const e=(g.playlist.manifest.mediaSequence?g.playlist.manifest.mediaSequence:0)+g.segmentIndex;t.playQueue.length>0&&t.playQueue[t.playQueue.length-1].segmentSequence!==e-1&&(t.playQueue=[]),t.segmentRequest&&t.segmentRequest.onError("Cancel segment request: simultaneous segment requests are not supported");const D=new Promise((h,f)=>{t.segmentRequest=new E(r,l,e,g.playlist.requestUrl,(s,i)=>h({content:s,downloadBandwidth:i}),s=>f(s))});return t.playQueue.push({segmentUrl:r,segmentByteRange:l,segmentSequence:e}),t.loadSegments(g.playlist,g.segmentIndex,!0),D})()}setPlayingSegment(r,l,t,n){const g=this.playQueue.findIndex(w=>w.segmentUrl===r&&v.compareByteRanges(w.segmentByteRange,l));g>=0&&(this.playQueue=this.playQueue.slice(g),this.playQueue[0].playPosition={start:t,duration:n},this.updateSegments())}setPlayingSegmentByCurrentTime(r){if(0===this.playQueue.length||!this.playQueue[0].playPosition)return;const l=this.playQueue[0].playPosition;l.start+l.duration-r<.2&&(this.playQueue=this.playQueue.slice(1),this.updateSegments())}abortSegment(r,l){this.segmentRequest&&this.segmentRequest.segmentUrl===r&&v.compareByteRanges(this.segmentRequest.segmentByteRange,l)&&(this.segmentRequest.onSuccess(void 0,0),this.segmentRequest=null)}destroy(){var r=this;return I(function*(){r.segmentRequest&&(r.segmentRequest.onError("Loading aborted: object destroyed"),r.segmentRequest=null),r.masterPlaylist=null,r.variantPlaylists.clear(),r.playQueue=[],void 0!==r.settings.assetsStorage&&(yield r.settings.assetsStorage.destroy()),yield r.loader.destroy()})()}updateSegments(){if(!this.segmentRequest)return;const r=this.getSegmentLocation(this.segmentRequest.segmentUrl,this.segmentRequest.segmentByteRange);r&&this.loadSegments(r.playlist,r.segmentIndex,!1)}getSegmentLocation(r,l){for(const t of this.variantPlaylists.values()){const n=t.getSegmentIndex(r,l);if(n>=0)return{playlist:t,segmentIndex:n}}}loadSegments(r,l,t){var n=this;return I(function*(){var g;const w=[],e=r.manifest.segments,D=null!==(g=r.manifest.mediaSequence)&&void 0!==g?g:0;let h=null,f=Math.max(0,n.playQueue.length-1);const s=n.getMasterSwarmId();for(let i=l;i<e.length&&w.length<n.settings.forwardSegmentCount;++i){const d=r.manifest.segments[i],u=r.getSegmentAbsoluteUrl(d.uri),b=d.byterange,p=n.getSegmentId(r,D+i);w.push({id:p,url:u,masterSwarmId:void 0!==s?s:r.streamSwarmId,masterManifestUri:null!==n.masterPlaylist?n.masterPlaylist.requestUrl:r.requestUrl,streamId:r.streamId,sequence:(D+i).toString(),range:v.byteRangeToString(b),priority:f++}),t&&!h&&(h=p)}if(n.loader.load(w,r.streamSwarmId),h){const i=yield n.loader.getSegment(h);i&&n.onSegmentLoaded(i)}})()}getSegmentId(r,l){return`${r.streamSwarmId}+${l}`}getMasterSwarmId(){const r=this.settings.swarmId&&0!==this.settings.swarmId.length?this.settings.swarmId:void 0;return void 0!==r?r:null!==this.masterPlaylist?this.masterPlaylist.requestUrl.split("?")[0]:void 0}getStreamSwarmId(r){const l=this.getMasterSwarmId();if(this.masterPlaylist&&this.masterPlaylist.manifest.playlists&&l)for(let t=0;t<this.masterPlaylist.manifest.playlists.length;++t)if(new URL(this.masterPlaylist.manifest.playlists[t].uri,this.masterPlaylist.responseUrl).toString()===r)return{streamSwarmId:`${l}+V${t}`,found:!0,index:t};return{streamSwarmId:null!=l?l:r.split("?")[0],found:!1,index:-1}}loadContent(r,l,t){var n=this;return I(function*(){return new Promise((g,w)=>{const e=new XMLHttpRequest;e.open("GET",r,!0),e.responseType=l,t&&e.setRequestHeader("Range",t),e.addEventListener("readystatechange",()=>{4===e.readyState&&(e.status>=200&&e.status<300?g(e):w(e.statusText))});const D=n.loader.getSettings().xhrSetup;D&&D(e,r),e.send()})})()}};class M{constructor(r,l,t){this.requestUrl=r,this.responseUrl=l,this.manifest=t,this.streamSwarmId=""}getSegmentIndex(r,l){for(let t=0;t<this.manifest.segments.length;++t){const n=this.manifest.segments[t];if(r===this.getSegmentAbsoluteUrl(n.uri)&&v.compareByteRanges(n.byterange,l))return t}return-1}getSegmentAbsoluteUrl(r){return new URL(r,this.responseUrl).toString()}}class E{constructor(r,l,t,n,g,w){this.segmentUrl=r,this.segmentByteRange=l,this.segmentSequence=t,this.playlistRequestUrl=n,this.onSuccess=g,this.onError=w}}},51961:(U,y,T)=>{"use strict";function I(s,i){return(I=Object.setPrototypeOf||function(u,b){return u.__proto__=b,u})(s,i)}function _(s,i){s.prototype=Object.create(i.prototype),s.prototype.constructor=s,I(s,i)}T.r(y),T.d(y,{LineStream:()=>r,ParseStream:()=>w,Parser:()=>f});var P=function(){function s(){this.listeners={}}var i=s.prototype;return i.on=function(u,b){this.listeners[u]||(this.listeners[u]=[]),this.listeners[u].push(b)},i.off=function(u,b){if(!this.listeners[u])return!1;var p=this.listeners[u].indexOf(b);return this.listeners[u]=this.listeners[u].slice(0),this.listeners[u].splice(p,1),p>-1},i.trigger=function(u){var b=this.listeners[u];if(b)if(2===arguments.length)for(var p=b.length,a=0;a<p;++a)b[a].call(this,arguments[1]);else for(var o=Array.prototype.slice.call(arguments,1),C=b.length,A=0;A<C;++A)b[A].apply(this,o)},i.dispose=function(){this.listeners={}},i.pipe=function(u){this.on("data",function(b){u.push(b)})},s}();function v(){return(v=Object.assign||function(s){for(var i=1;i<arguments.length;i++){var d=arguments[i];for(var u in d)Object.prototype.hasOwnProperty.call(d,u)&&(s[u]=d[u])}return s}).apply(this,arguments)}var S=T(12499),M=T.n(S);function c(s){for(var i=function(i){return M().atob?M().atob(i):Buffer.from(i,"base64").toString("binary")}(s),d=new Uint8Array(i.length),u=0;u<i.length;u++)d[u]=i.charCodeAt(u);return d}var r=function(s){function i(){var u;return(u=s.call(this)||this).buffer="",u}return _(i,s),i.prototype.push=function(b){var p;for(this.buffer+=b,p=this.buffer.indexOf("\n");p>-1;p=this.buffer.indexOf("\n"))this.trigger("data",this.buffer.substring(0,p)),this.buffer=this.buffer.substring(p+1)},i}(P),l=String.fromCharCode(9),t=function(i){var d=/([0-9.]*)?@?([0-9.]*)?/.exec(i||""),u={};return d[1]&&(u.length=parseInt(d[1],10)),d[2]&&(u.offset=parseInt(d[2],10)),u},g=function(i){for(var p,d=i.split(new RegExp('(?:^|,)((?:[^=]*)=(?:"[^"]*"|[^,]*))')),u={},b=d.length;b--;)""!==d[b]&&((p=/([^=]*)=(.*)/.exec(d[b]).slice(1))[0]=p[0].replace(/^\s+|\s+$/g,""),p[1]=p[1].replace(/^\s+|\s+$/g,""),p[1]=p[1].replace(/^['"](.*)['"]$/g,"$1"),u[p[0]]=p[1]);return u},w=function(s){function i(){var u;return(u=s.call(this)||this).customParsers=[],u.tagMappers=[],u}_(i,s);var d=i.prototype;return d.push=function(b){var a,o,p=this;if(0!==(b=b.trim()).length){if("#"!==b[0])return void this.trigger("data",{type:"uri",uri:b});this.tagMappers.reduce(function(A,H){var N=H(b);return N===b?A:A.concat([N])},[b]).forEach(function(A){for(var H=0;H<p.customParsers.length;H++)if(p.customParsers[H].call(p,A))return;if(0===A.indexOf("#EXT"))if(A=A.replace("\r",""),a=/^#EXTM3U/.exec(A))p.trigger("data",{type:"tag",tagType:"m3u"});else{if(a=/^#EXTINF:?([0-9\.]*)?,?(.*)?$/.exec(A))return o={type:"tag",tagType:"inf"},a[1]&&(o.duration=parseFloat(a[1])),a[2]&&(o.title=a[2]),void p.trigger("data",o);if(a=/^#EXT-X-TARGETDURATION:?([0-9.]*)?/.exec(A))return o={type:"tag",tagType:"targetduration"},a[1]&&(o.duration=parseInt(a[1],10)),void p.trigger("data",o);if(a=/^#EXT-X-VERSION:?([0-9.]*)?/.exec(A))return o={type:"tag",tagType:"version"},a[1]&&(o.version=parseInt(a[1],10)),void p.trigger("data",o);if(a=/^#EXT-X-MEDIA-SEQUENCE:?(\-?[0-9.]*)?/.exec(A))return o={type:"tag",tagType:"media-sequence"},a[1]&&(o.number=parseInt(a[1],10)),void p.trigger("data",o);if(a=/^#EXT-X-DISCONTINUITY-SEQUENCE:?(\-?[0-9.]*)?/.exec(A))return o={type:"tag",tagType:"discontinuity-sequence"},a[1]&&(o.number=parseInt(a[1],10)),void p.trigger("data",o);if(a=/^#EXT-X-PLAYLIST-TYPE:?(.*)?$/.exec(A))return o={type:"tag",tagType:"playlist-type"},a[1]&&(o.playlistType=a[1]),void p.trigger("data",o);if(a=/^#EXT-X-BYTERANGE:?(.*)?$/.exec(A))return o=v(t(a[1]),{type:"tag",tagType:"byterange"}),void p.trigger("data",o);if(a=/^#EXT-X-ALLOW-CACHE:?(YES|NO)?/.exec(A))return o={type:"tag",tagType:"allow-cache"},a[1]&&(o.allowed=!/NO/.test(a[1])),void p.trigger("data",o);if(a=/^#EXT-X-MAP:?(.*)$/.exec(A)){if(o={type:"tag",tagType:"map"},a[1]){var N=g(a[1]);N.URI&&(o.uri=N.URI),N.BYTERANGE&&(o.byterange=t(N.BYTERANGE))}p.trigger("data",o)}else if(a=/^#EXT-X-STREAM-INF:?(.*)$/.exec(A)){if(o={type:"tag",tagType:"stream-inf"},a[1]){if(o.attributes=g(a[1]),o.attributes.RESOLUTION){var j=o.attributes.RESOLUTION.split("x"),k={};j[0]&&(k.width=parseInt(j[0],10)),j[1]&&(k.height=parseInt(j[1],10)),o.attributes.RESOLUTION=k}o.attributes.BANDWIDTH&&(o.attributes.BANDWIDTH=parseInt(o.attributes.BANDWIDTH,10)),o.attributes["PROGRAM-ID"]&&(o.attributes["PROGRAM-ID"]=parseInt(o.attributes["PROGRAM-ID"],10))}p.trigger("data",o)}else{if(a=/^#EXT-X-MEDIA:?(.*)$/.exec(A))return o={type:"tag",tagType:"media"},a[1]&&(o.attributes=g(a[1])),void p.trigger("data",o);if(a=/^#EXT-X-ENDLIST/.exec(A))p.trigger("data",{type:"tag",tagType:"endlist"});else{if(!(a=/^#EXT-X-DISCONTINUITY/.exec(A)))return(a=/^#EXT-X-PROGRAM-DATE-TIME:?(.*)$/.exec(A))?(o={type:"tag",tagType:"program-date-time"},a[1]&&(o.dateTimeString=a[1],o.dateTimeObject=new Date(a[1])),void p.trigger("data",o)):(a=/^#EXT-X-KEY:?(.*)$/.exec(A))?(o={type:"tag",tagType:"key"},a[1]&&(o.attributes=g(a[1]),o.attributes.IV&&("0x"===o.attributes.IV.substring(0,2).toLowerCase()&&(o.attributes.IV=o.attributes.IV.substring(2)),o.attributes.IV=o.attributes.IV.match(/.{8}/g),o.attributes.IV[0]=parseInt(o.attributes.IV[0],16),o.attributes.IV[1]=parseInt(o.attributes.IV[1],16),o.attributes.IV[2]=parseInt(o.attributes.IV[2],16),o.attributes.IV[3]=parseInt(o.attributes.IV[3],16),o.attributes.IV=new Uint32Array(o.attributes.IV))),void p.trigger("data",o)):(a=/^#EXT-X-START:?(.*)$/.exec(A))?(o={type:"tag",tagType:"start"},a[1]&&(o.attributes=g(a[1]),o.attributes["TIME-OFFSET"]=parseFloat(o.attributes["TIME-OFFSET"]),o.attributes.PRECISE=/YES/.test(o.attributes.PRECISE)),void p.trigger("data",o)):(a=/^#EXT-X-CUE-OUT-CONT:?(.*)?$/.exec(A))?((o={type:"tag",tagType:"cue-out-cont"}).data=a[1]?a[1]:"",void p.trigger("data",o)):(a=/^#EXT-X-CUE-OUT:?(.*)?$/.exec(A))?((o={type:"tag",tagType:"cue-out"}).data=a[1]?a[1]:"",void p.trigger("data",o)):(a=/^#EXT-X-CUE-IN:?(.*)?$/.exec(A))?((o={type:"tag",tagType:"cue-in"}).data=a[1]?a[1]:"",void p.trigger("data",o)):(a=/^#EXT-X-SKIP:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"skip"}).attributes=g(a[1]),o.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(o.attributes["SKIPPED-SEGMENTS"]=parseInt(o.attributes["SKIPPED-SEGMENTS"],10)),o.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(o.attributes["RECENTLY-REMOVED-DATERANGES"]=o.attributes["RECENTLY-REMOVED-DATERANGES"].split(l)),void p.trigger("data",o)):(a=/^#EXT-X-PART:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"part"}).attributes=g(a[1]),["DURATION"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=parseFloat(o.attributes[O]))}),["INDEPENDENT","GAP"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=/YES/.test(o.attributes[O]))}),o.attributes.hasOwnProperty("BYTERANGE")&&(o.attributes.byterange=t(o.attributes.BYTERANGE)),void p.trigger("data",o)):(a=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"server-control"}).attributes=g(a[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=parseFloat(o.attributes[O]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=/YES/.test(o.attributes[O]))}),void p.trigger("data",o)):(a=/^#EXT-X-PART-INF:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"part-inf"}).attributes=g(a[1]),["PART-TARGET"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=parseFloat(o.attributes[O]))}),void p.trigger("data",o)):(a=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"preload-hint"}).attributes=g(a[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(O){if(o.attributes.hasOwnProperty(O)){o.attributes[O]=parseInt(o.attributes[O],10);var G="BYTERANGE-LENGTH"===O?"length":"offset";o.attributes.byterange=o.attributes.byterange||{},o.attributes.byterange[G]=o.attributes[O],delete o.attributes[O]}}),void p.trigger("data",o)):(a=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(A))&&a[1]?((o={type:"tag",tagType:"rendition-report"}).attributes=g(a[1]),["LAST-MSN","LAST-PART"].forEach(function(O){o.attributes.hasOwnProperty(O)&&(o.attributes[O]=parseInt(o.attributes[O],10))}),void p.trigger("data",o)):void p.trigger("data",{type:"tag",data:A.slice(4)});p.trigger("data",{type:"tag",tagType:"discontinuity"})}}}else p.trigger("data",{type:"comment",text:A.slice(1)})})}},d.addParser=function(b){var p=this,a=b.expression,o=b.customType,C=b.dataParser,A=b.segment;"function"!=typeof C&&(C=function(N){return N}),this.customParsers.push(function(H){if(a.exec(H))return p.trigger("data",{type:"custom",data:C(H),customType:o,segment:A}),!0})},d.addTagMapper=function(b){var p=b.expression,a=b.map;this.tagMappers.push(function(A){return p.test(A)?a(A):A})},i}(P),D=function(i){var d={};return Object.keys(i).forEach(function(u){d[function(i){return i.toLowerCase().replace(/-(\w)/g,function(d){return d[1].toUpperCase()})}(u)]=i[u]}),d},h=function(i){var d=i.serverControl,u=i.targetDuration,b=i.partTargetDuration;if(d){var p="#EXT-X-SERVER-CONTROL",a="holdBack",o="partHoldBack",C=u&&3*u,A=b&&2*b;u&&!d.hasOwnProperty(a)&&(d[a]=C,this.trigger("info",{message:p+" defaulting HOLD-BACK to targetDuration * 3 ("+C+")."})),C&&d[a]<C&&(this.trigger("warn",{message:p+" clamping HOLD-BACK ("+d[a]+") to targetDuration * 3 ("+C+")"}),d[a]=C),b&&!d.hasOwnProperty(o)&&(d[o]=3*b,this.trigger("info",{message:p+" defaulting PART-HOLD-BACK to partTargetDuration * 3 ("+d[o]+")."})),b&&d[o]<A&&(this.trigger("warn",{message:p+" clamping PART-HOLD-BACK ("+d[o]+") to partTargetDuration * 2 ("+A+")."}),d[o]=A)}},f=function(s){function i(){var u;(u=s.call(this)||this).lineStream=new r,u.parseStream=new w,u.lineStream.pipe(u.parseStream);var o,C,b=function(s){if(void 0===s)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return s}(u),p=[],a={},A=!1,H=function(){},N={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},k=0;u.manifest={allowCache:!0,discontinuityStarts:[],segments:[]};var O=0,G=0;return u.on("end",function(){a.uri||!a.parts&&!a.preloadHints||(!a.map&&o&&(a.map=o),!a.key&&C&&(a.key=C),!a.timeline&&"number"==typeof k&&(a.timeline=k),u.manifest.preloadSegment=a)}),u.parseStream.on("data",function(m){var $,X;({tag:function(){({version:function(){m.version&&(this.manifest.version=m.version)},"allow-cache":function(){this.manifest.allowCache=m.allowed,"allowed"in m||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange:function(){var L={};"length"in m&&(a.byterange=L,L.length=m.length,"offset"in m||(m.offset=O)),"offset"in m&&(a.byterange=L,L.offset=m.offset),O=L.offset+L.length},endlist:function(){this.manifest.endList=!0},inf:function(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),m.duration>0&&(a.duration=m.duration),0===m.duration&&(a.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=p},key:function(){if(m.attributes)if("NONE"!==m.attributes.METHOD)if(m.attributes.URI){if("com.apple.streamingkeydelivery"===m.attributes.KEYFORMAT)return this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:m.attributes});if("urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"===m.attributes.KEYFORMAT)return-1===["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(m.attributes.METHOD)?void this.trigger("warn",{message:"invalid key method provided for Widevine"}):("SAMPLE-AES-CENC"===m.attributes.METHOD&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),"data:text/plain;base64,"!==m.attributes.URI.substring(0,23)?void this.trigger("warn",{message:"invalid key URI provided for Widevine"}):m.attributes.KEYID&&"0x"===m.attributes.KEYID.substring(0,2)?(this.manifest.contentProtection=this.manifest.contentProtection||{},void(this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:m.attributes.KEYFORMAT,keyId:m.attributes.KEYID.substring(2)},pssh:c(m.attributes.URI.split(",")[1])})):void this.trigger("warn",{message:"invalid key ID provided for Widevine"}));m.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),C={method:m.attributes.METHOD||"AES-128",uri:m.attributes.URI},void 0!==m.attributes.IV&&(C.iv=m.attributes.IV)}else this.trigger("warn",{message:"ignoring key declaration without URI"});else C=null;else this.trigger("warn",{message:"ignoring key declaration without attribute list"})},"media-sequence":function(){isFinite(m.number)?this.manifest.mediaSequence=m.number:this.trigger("warn",{message:"ignoring invalid media sequence: "+m.number})},"discontinuity-sequence":function(){isFinite(m.number)?(this.manifest.discontinuitySequence=m.number,k=m.number):this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+m.number})},"playlist-type":function(){/VOD|EVENT/.test(m.playlistType)?this.manifest.playlistType=m.playlistType:this.trigger("warn",{message:"ignoring unknown playlist type: "+m.playlist})},map:function(){o={},m.uri&&(o.uri=m.uri),m.byterange&&(o.byterange=m.byterange),C&&(o.key=C)},"stream-inf":function(){this.manifest.playlists=p,this.manifest.mediaGroups=this.manifest.mediaGroups||N,m.attributes?(a.attributes||(a.attributes={}),v(a.attributes,m.attributes)):this.trigger("warn",{message:"ignoring empty stream-inf attributes"})},media:function(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||N,m.attributes&&m.attributes.TYPE&&m.attributes["GROUP-ID"]&&m.attributes.NAME){var L=this.manifest.mediaGroups[m.attributes.TYPE];L[m.attributes["GROUP-ID"]]=L[m.attributes["GROUP-ID"]]||{},$=L[m.attributes["GROUP-ID"]],(X={default:/yes/i.test(m.attributes.DEFAULT)}).autoselect=!!X.default||/yes/i.test(m.attributes.AUTOSELECT),m.attributes.LANGUAGE&&(X.language=m.attributes.LANGUAGE),m.attributes.URI&&(X.uri=m.attributes.URI),m.attributes["INSTREAM-ID"]&&(X.instreamId=m.attributes["INSTREAM-ID"]),m.attributes.CHARACTERISTICS&&(X.characteristics=m.attributes.CHARACTERISTICS),m.attributes.FORCED&&(X.forced=/yes/i.test(m.attributes.FORCED)),$[m.attributes.NAME]=X}else this.trigger("warn",{message:"ignoring incomplete or missing media group"})},discontinuity:function(){k+=1,a.discontinuity=!0,this.manifest.discontinuityStarts.push(p.length)},"program-date-time":function(){void 0===this.manifest.dateTimeString&&(this.manifest.dateTimeString=m.dateTimeString,this.manifest.dateTimeObject=m.dateTimeObject),a.dateTimeString=m.dateTimeString,a.dateTimeObject=m.dateTimeObject},targetduration:function(){!isFinite(m.duration)||m.duration<0?this.trigger("warn",{message:"ignoring invalid target duration: "+m.duration}):(this.manifest.targetDuration=m.duration,h.call(this,this.manifest))},start:function(){m.attributes&&!isNaN(m.attributes["TIME-OFFSET"])?this.manifest.start={timeOffset:m.attributes["TIME-OFFSET"],precise:m.attributes.PRECISE}:this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"})},"cue-out":function(){a.cueOut=m.data},"cue-out-cont":function(){a.cueOutCont=m.data},"cue-in":function(){a.cueIn=m.data},skip:function(){this.manifest.skip=D(m.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",m.attributes,["SKIPPED-SEGMENTS"])},part:function(){var L=this;A=!0;var q=this.manifest.segments.length,x=D(m.attributes);a.parts=a.parts||[],a.parts.push(x),x.byterange&&(x.byterange.hasOwnProperty("offset")||(x.byterange.offset=G),G=x.byterange.offset+x.byterange.length),this.warnOnMissingAttributes_("#EXT-X-PART #"+(a.parts.length-1)+" for segment #"+q,m.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach(function(F,z){F.hasOwnProperty("lastPart")||L.trigger("warn",{message:"#EXT-X-RENDITION-REPORT #"+z+" lacks required attribute(s): LAST-PART"})})},"server-control":function(){var L=this.manifest.serverControl=D(m.attributes);L.hasOwnProperty("canBlockReload")||(L.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),h.call(this,this.manifest),L.canSkipDateranges&&!L.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint":function(){var L=this.manifest.segments.length,q=D(m.attributes),x=q.type&&"PART"===q.type;a.preloadHints=a.preloadHints||[],a.preloadHints.push(q),q.byterange&&(q.byterange.hasOwnProperty("offset")||(q.byterange.offset=x?G:0,x&&(G=q.byterange.offset+q.byterange.length)));var V=a.preloadHints.length-1;if(this.warnOnMissingAttributes_("#EXT-X-PRELOAD-HINT #"+V+" for segment #"+L,m.attributes,["TYPE","URI"]),q.type)for(var F=0;F<a.preloadHints.length-1;F++){var z=a.preloadHints[F];!z.type||z.type===q.type&&this.trigger("warn",{message:"#EXT-X-PRELOAD-HINT #"+V+" for segment #"+L+" has the same TYPE "+q.type+" as preload hint #"+F})}},"rendition-report":function(){var L=D(m.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(L);var q=this.manifest.renditionReports.length-1,x=["LAST-MSN","URI"];A&&x.push("LAST-PART"),this.warnOnMissingAttributes_("#EXT-X-RENDITION-REPORT #"+q,m.attributes,x)},"part-inf":function(){this.manifest.partInf=D(m.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",m.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),h.call(this,this.manifest)}}[m.tagType]||H).call(b)},uri:function(){a.uri=m.uri,p.push(a),this.manifest.targetDuration&&!("duration"in a)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),a.duration=this.manifest.targetDuration),C&&(a.key=C),a.timeline=k,o&&(a.map=o),G=0,a={}},comment:function(){},custom:function(){m.segment?(a.custom=a.custom||{},a.custom[m.customType]=m.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[m.customType]=m.data)}})[m.type].call(b)}),u}_(i,s);var d=i.prototype;return d.warnOnMissingAttributes_=function(b,p,a){var o=[];a.forEach(function(C){p.hasOwnProperty(C)||o.push(C)}),o.length&&this.trigger("warn",{message:b+" lacks required attribute(s): "+o.join(", ")})},d.push=function(b){this.lineStream.push(b)},d.end=function(){this.lineStream.push("\n"),this.trigger("end")},d.addParser=function(b){this.parseStream.addParser(b)},d.addTagMapper=function(b){this.parseStream.addTagMapper(b)},i}(P)},790:(U,y,T)=>{var I=T(39228).Buffer;function _(P,v){this._block=I.alloc(P),this._finalSize=v,this._blockSize=P,this._len=0}_.prototype.update=function(P,v){"string"==typeof P&&(P=I.from(P,v=v||"utf8"));for(var R=this._block,S=this._blockSize,M=P.length,E=this._len,c=0;c<M;){for(var r=E%S,l=Math.min(M-c,S-r),t=0;t<l;t++)R[r+t]=P[c+t];c+=l,(E+=l)%S==0&&this._update(R)}return this._len+=M,this},_.prototype.digest=function(P){var v=this._len%this._blockSize;this._block[v]=128,this._block.fill(0,v+1),v>=this._finalSize&&(this._update(this._block),this._block.fill(0));var R=8*this._len;if(R<=4294967295)this._block.writeUInt32BE(R,this._blockSize-4);else{var S=(4294967295&R)>>>0;this._block.writeUInt32BE((R-S)/4294967296,this._blockSize-8),this._block.writeUInt32BE(S,this._blockSize-4)}this._update(this._block);var E=this._hash();return P?E.toString(P):E},_.prototype._update=function(){throw new Error("_update must be implemented by subclass")},U.exports=_},24274:(U,y,T)=>{var I=T(18134),_=T(790),P=T(39228).Buffer,v=[1518500249,1859775393,-1894007588,-899497514],R=new Array(80);function S(){this.init(),this._w=R,_.call(this,64,56)}function M(l){return l<<1|l>>>31}function E(l){return l<<5|l>>>27}function c(l){return l<<30|l>>>2}function r(l,t,n,g){return 0===l?t&n|~t&g:2===l?t&n|t&g|n&g:t^n^g}I(S,_),S.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this},S.prototype._update=function(l){for(var t=this._w,n=0|this._a,g=0|this._b,w=0|this._c,e=0|this._d,D=0|this._e,h=0;h<16;++h)t[h]=l.readInt32BE(4*h);for(;h<80;++h)t[h]=M(t[h-3]^t[h-8]^t[h-14]^t[h-16]);for(var f=0;f<80;++f){var s=~~(f/20),i=E(n)+r(s,g,w,e)+D+t[f]+v[s]|0;D=e,e=w,w=c(g),g=n,n=i}this._a=n+this._a|0,this._b=g+this._b|0,this._c=w+this._c|0,this._d=e+this._d|0,this._e=D+this._e|0},S.prototype._hash=function(){var l=P.allocUnsafe(20);return l.writeInt32BE(0|this._a,0),l.writeInt32BE(0|this._b,4),l.writeInt32BE(0|this._c,8),l.writeInt32BE(0|this._d,12),l.writeInt32BE(0|this._e,16),l},U.exports=S}}]);